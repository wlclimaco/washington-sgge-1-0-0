<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="documentTypeMap">

  <!-- Result maps describe the mapping between the columns returned
       from a query, and the class properties.  A result map isn't
       necessary if the columns (or aliases) match to the properties
       exactly. -->

  	<resultMap id="changeControlMapping" type="QATModel">
  		<result property="createUser" column="create_user"/>
		<result property="createDateUTC" column="create_date"/>
		<result property="modifyUser" column="modify_user"/>
		<result property="modifyDateUTC" column="modify_date"/>
	</resultMap>

  	<resultMap id="documentTypeResult" type="DocumentType" extends="changeControlMapping">
		<result property="id" column="document_type_id" />
		<result property="name" column="name" />
		<result property="description" column="description" />
		<result property="applicabilityValue" column="applicability" />
  	</resultMap>

	<!--
		SQL fragments allow "parts" of SQL to be re-used in other SQL statements.
	-->
	<sql id="allChangeControlColumns">
		create_date,
  		create_user,
  		modify_date,
  		modify_user
  	</sql>

  	<sql id="allDocumentTypeColumns">
  		document_type_id,
  		name,
  		description,
		applicability,
		<include refid="allChangeControlColumns"/>
  	</sql>

  	<sql id="allDocumentTypeColumnsWithAlias">
  		dt.document_type_id,
  		dt.name,
  		dt.description,
		dt.applicability
  	</sql>

     <sql id="changeControlFields">
    	#{createDateUTC},
		#{createUser},
		#{modifyDateUTC},
		#{modifyUser}
     </sql>


	<!--
		SQL Fetch Statements.
	-->

	<select id="fetchDocumentTypeByRequest" parameterType="DocumentTypeRequest" resultMap="documentTypeResult">
		SELECT
			<include refid="allDocumentTypeColumnsWithAlias" />
  		FROM document_type dt

  		<if test="countryCode != null">
  			JOIN country_document_type cdt ON (cdt.FK_document_type_id = dt.document_type_id)
  		</if>
  		<where>
  			<choose>
  				<when test="businessTypeValue != null">
  					AND dt.applicability = #{businessTypeValue}
  				</when>
  				<otherwise>
  				  	AND dt.applicability = 3
  				</otherwise>
  			</choose>
  			<if test="countryCode != null">
				AND cdt.FK_country_code = #{countryCode}
  			</if>
  		</where>
  	</select>

</mapper>
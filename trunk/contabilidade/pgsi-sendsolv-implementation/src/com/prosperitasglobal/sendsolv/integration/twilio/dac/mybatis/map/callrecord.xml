<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="CallRecordMap">

	<!-- <cache type="org.mybatis.caches.ehcache.LoggingEhcache"/>
	<cache type="org.mybatis.caches.ehcache.EhcacheCache"/>  -->

  	<!-- Result maps describe the mapping between the columns returned
       from a query, and the class properties.  A result map isn't
       necessary if the columns (or aliases) match to the properties
       exactly. -->

    <resultMap id="callRecordResult" type="CallRecord" extends="changeControlMapping">
		<result property="id" column="call_record_id"/>
		<result property="callSid" column="call_sid"/>
		<result property="parentPersonId" column="FK_person_id"/>
		<result property="originatingPhone" column="originating_phone"/>
		<result property="currentIvrOption" column="current_ivr_option"/>
		<result property="currentSearchDate" column="current_search_date"/>
		<result property="startDateTimeUTC" column="start_datetime"/>
		<result property="stopDateTimeUTC" column="stop_datetime"/>
		<result property="callDurationSeconds" column="call_duration_seconds"/>
		<result property="language" column="language"/>

		<collection property="callRecordContextList" column="call_record_id" select="fetchcallRecordContextListByCallRecordId"/>
  	</resultMap>

  	<resultMap id="callRecordContextResult" type="CallRecordContext" extends="changeControlMapping">
		<result property="parentId" column="FK_call_record_id"/>
		<result property="ivrOption" column="ivr_option"/>
		<result property="recipientFirstName" column="recipient_first_name"/>
		<result property="recipientLastName" column="recipient_last_name"/>
		<result property="moneyTransferId" column="FK_money_transfer_id"/>
  	</resultMap>

  	<resultMap id="moneyTransferSummaryResult" type="MoneyTransferSummary" extends="changeControlMapping">
  		<result property="personId" column="person_id"/>
		<result property="firstName" column="first_name"/>
		<result property="lastName" column="last_name"/>
		<result property="moneyTransferId" column="money_transfer_id"/>
		<result property="confirmationNumber" column="confirmation_number"/>
  	</resultMap>

  	<resultMap id="changeControlMapping" type="QATModel">
  		<result property="createUser" column="create_user"/>
		<result property="createDateUTC" column="create_date"/>
		<result property="modifyUser" column="modify_user"/>
		<result property="modifyDateUTC" column="modify_date"/>
	</resultMap>

  <!--
		SQL fragments allow "parts" of SQL to be re-used in other SQL statements.
	-->
  	<sql id="allCallRecordColumns">
		call_sid,
		FK_person_id,
		originating_phone,
		start_datetime,
		stop_datetime,
		call_duration_seconds,
		language,
		current_ivr_option,
		current_search_date,
		create_date,
		create_user,
		modify_date,
		modify_user
  	</sql>

	<sql id="allCallRecordValues">
  		#{callSid},
		#{parentPersonId},
		#{originatingPhone},
		#{startDateTimeUTC},
		#{stopDateTimeUTC},
		#{callDurationSeconds},
		#{language},
		#{currentIvrOption},
		#{currentSearchDate},
    	#{createDateUTC},
    	#{createUser},
    	#{modifyDateUTC},
    	#{modifyUser}
  	</sql>

  	<sql id="allCallRecordContextColumns">
		 FK_call_record_id
      	,ivr_option
      	,FK_money_transfer_id
      	,recipient_first_name
      	,recipient_last_name
      	,create_date
      	,create_user
      	,modify_date
      	,modify_user
  	</sql>

  	<sql id="allCallRecordContextValues">
		 #{parentId}
      	,#{ivrOption}
      	,#{moneyTransferId}
      	,#{recipientFirstName}
      	,#{recipientLastName}
      	,#{createDateUTC}
    	,#{createUser}
    	,#{modifyDateUTC}
    	,#{modifyUser}
  	</sql>

  	<!--************************
		SQL Insert Statements.
 	****************************-->
	<insert id="insertCallRecord" parameterType="CallRecord" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO call_record
	    	(<include refid="allCallRecordColumns"/>)
	    VALUES
	        (<include refid="allCallRecordValues"/>)
	</insert>

	<insert id="insertCallRecordContext" parameterType="CallRecordContext">
		INSERT INTO call_record_context
	    	(<include refid="allCallRecordContextColumns"/>)
	    VALUES
	        (<include refid="allCallRecordContextValues"/>)
	</insert>

	<!--************************
		SQL Update Statements.
 	****************************-->
 	<update id="updateCallRecord" parameterType="CallRecord">
	    UPDATE call_record
	    	<set>
	    		<if test="parentPersonId!=null">FK_person_id=#{parentPersonId},</if>
	    		<if test="language!=null">language=#{language},</if>
	    		<if test="stopDateTimeUTC!=null">stop_datetime=#{stopDateTimeUTC},</if>
		    	<if test="callDurationSeconds!= null"> call_duration_seconds=#{callDurationSeconds},</if>
				<if test="modifyDateUTC!= null"> modify_date=#{modifyDateUTC},</if>
				<if test="modifyUser!= null"> modify_user=#{modifyUser},</if>
				<if test="currentIvrOption!= null"> current_ivr_option=#{currentIvrOption},</if>
				<if test="originatingPhone!= null"> originating_phone=#{originatingPhone},</if>
				current_search_date=#{currentSearchDate}
			</set>
	    WHERE call_sid = #{callSid}
	</update>

	<!--************************
		SQL Delete Statements.
 	****************************-->
 	<delete id="deleteCallRecordContext" parameterType="Integer">
	    DELETE FROM call_record_context WHERE FK_call_record_id = #{id}
	</delete>

	<!--************************
		SQL Fetch Statements.
 	****************************-->
	<select id="fetchFullCallRecordHistoryByPerson" parameterType="Integer" resultMap="callRecordResult">
		SELECT call_record_id
		,<include refid="allCallRecordColumns"/>
		FROM call_record
		WHERE FK_person_id =#{id}
		ORDER BY call_record_id
 	</select>

 	<select id="fetchCallBySid" parameterType="String" resultMap="callRecordResult">
		SELECT call_record_id
		,<include refid="allCallRecordColumns"/>
		FROM call_record
		WHERE call_sid =#{id}
		ORDER BY call_record_id
 	</select>

 	<select id="fetchcallRecordContextListByCallRecordId" parameterType="Integer" resultMap="callRecordContextResult">
		SELECT
			<include refid="allCallRecordContextColumns"/>
  		FROM call_record_context
  		WHERE FK_call_record_id = #{id}
  	</select>

	<select id="fetchPhoneBySid" parameterType="String" resultType="Integer">
		SELECT	count(p.person_id)
		FROM  	contact c INNER JOIN
	            person_contact pc ON c.contact_id = pc.FK_contact_id INNER JOIN
	            person  p ON pc.FK_person_id = p.person_id INNER JOIN
	            phone ph ON c.contact_id = ph.FK_contact_id INNER JOIN
	            country cn ON ph.FK_country_code = cn.country_code
		WHERE p.person_type = 2 AND CONCAT(cn.phone_code,ph.base_number) = #{id}
	</select>

	<select id="fetchPersonIdByIvrIdentity" parameterType="IvrIdentity" resultType="Integer">
		SELECT	p.person_id
		FROM  	contact c INNER JOIN
	            person_contact pc ON c.contact_id = pc.FK_contact_id INNER JOIN
	            person  p ON pc.FK_person_id = p.person_id INNER JOIN
	            phone ph ON c.contact_id = ph.FK_contact_id INNER JOIN
	            country cn ON ph.FK_country_code = cn.country_code
		WHERE p.person_type = 2
		AND CONCAT(cn.phone_code,ph.base_number) = #{phoneNumber}
		AND p.pin = #{pinNumber}
	</select>

  	<select id="fetchVersionNumber" parameterType="Integer" resultType="int">
		SELECT versn_lock_num FROM call_record WHERE call_record_id = #{id}
  	</select>

  	<select id="fetchMoneyTransferSummaryByMember" parameterType="MoneyTransferSummary" resultMap="moneyTransferSummaryResult">
	  	SELECT
		 	 member.person_id
		 	,recipient.first_name
			,recipient.last_name
			,mt.money_transfer_id
			,mt.create_date
			,mt.confirmation_number
		FROM	money_transfer AS mt INNER JOIN
                transfer_setting AS ts ON mt.FK_transfer_setting_id = ts.transfer_setting_id INNER JOIN
               	employment_information AS ei ON ts.FK_employment_information_id = ei.employment_information_id INNER JOIN
                person AS member ON ts.FK_member_id = member.person_id INNER JOIN
			 	person AS recipient ON ts.FK_recipient_id = recipient.person_id
			 	and member.person_id= #{personId}
		WHERE       CAST(dbo.fn_miliseconds_from_epoch_to_dt(mt.create_date) AS DATE) =
					CAST(dbo.fn_miliseconds_from_epoch_to_dt
						(
							(	SELECT TOP 1 mt.create_date
				 				FROM
									money_transfer mt INNER JOIN
									transfer_setting ts ON mt.FK_transfer_setting_id = ts.transfer_setting_id INNER JOIN
									employment_information ei ON ts.FK_employment_information_id = ei.employment_information_id INNER JOIN
									person p ON ei.FK_member_id = p.person_id
								WHERE p.person_id= #{personId} AND mt.create_date &lt; #{createDateUTC}
								ORDER BY mt.create_date DESC
							)
						)
					 AS DATE)
  	</select>

  	<select id="fetchCallRecordContextByIvrOption" parameterType="CallRecordContext" resultMap="callRecordContextResult">
		SELECT
			<include refid="allCallRecordContextColumns"/>
		FROM call_record_context
		WHERE FK_call_record_id = #{parentId} AND ivr_option = #{ivrOption}
 	</select>
</mapper>
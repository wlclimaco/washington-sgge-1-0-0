<?xml version="1.0"?>

<project name="install-tomcat" basedir="." default="install-all">

	<property name="tomcat-dir" value="/opt/flexnet-slc" />
	<property name="tomcat-slc-service.filename" value="/etc/init.d/flexnet-slc" />
	<property name="slc.properties.filename" value="sensus-lc.properties" />
	<property name="tomcat-host" value="localhost" />
	<property name="tomcat-port" value="8080" />

	<available property="tomcat.dir.exists" file="${tomcat-dir}" />

	<target name="install-tomcat" if="${tomcat.dir.exists}">
		<echo message="Installing Tomcat ..." />
		<untar src="${basedir}/tomcat-7.0.42.tar.gz" compression="gzip" dest="/opt/flexnet-slc" />
		<echo message="Fixing Tomcat directory permissions" />
		<chmod dir="${tomcat-dir}" perm="ugo+rx" includes="**/*.sh" />
		<chmod dir="${tomcat-dir}/logs" perm="777" />
		<chmod dir="${tomcat-dir}/webapps" perm="777" />
		<chmod dir="${tomcat-dir}/temp" perm="777" />
		<chmod dir="${tomcat-dir}/work" perm="777" />
		<chmod dir="${tomcat-dir}/csvtemp" perm="777" />

		<copy file="${basedir}/flexnet-slc" todir="/etc/init.d" overwrite="true" />

		<echo message="Installing flexnet-slc service" />
		<chmod file="${tomcat-slc-service.filename}" perm="ugo+rx" />
		<exec executable="/sbin/chkconfig" dir="/etc/init.d">
			<arg line="--levels 35 flexnet-slc on" />
		</exec>

	</target>

	<target name="start-tomcat">
		<echo message="Starting Tomcat ..." />
		<exec executable="${tomcat-slc-service.filename}">
			<arg line="start" />
		</exec>
		<echo message="Waiting 20 seconds for Tomcat to start ..." />
		<sleep seconds="20" />
	</target>

	<target name="verify-tomcat-started" depends="test-if-tomcat-is-running,tomcat-good-start,tomcat-bad-start" />

	<target name="tomcat-good-start" if="tomcat.running">
		<echo message="Tomcat started." />
		<exec executable="${tomcat-dir}/bin/version.sh" />
	</target>

	<target name="tomcat-bad-start" unless="tomcat.running">
		<fail message="Tomcat failed to start, please verify and if needed re-run this install." />
	</target>

	<target name="test-if-tomcat-is-running">
		<condition property="tomcat.running">
			<socket server="${tomcat-host}" port="${tomcat-port}" />
		</condition>
	</target>

	<target name="stop-tomcat" if="tomcat.dir.exists">
		<echo message="Stopping Tomcat ..." />
		<exec executable="${tomcat-slc-service.filename}">
			<arg line="stop" />
		</exec>

		<echo message="Waiting 20 seconds for Tomcat to shutdown ..." />
		<sleep seconds="20" />

		<echo message="Done Waiting for Tomcat to shutdown." />
		<echo message="Delete old tomcat directory[${tomcat-dir}]" />
		<delete dir="${tomcat-dir}" verbose="true" />
		<fail message="Tomcat removal not successfull, resolve and re-run this install.">
			<condition>
				<available file="${tomcat-dir}" />
			</condition>
		</fail>
	</target>

	<target name="copy-war" if="${tomcat.dir.exists}">
		<echo message="Installing slc.war file" />
		<copy file="slc.war" todir="${tomcat-dir}/webapps" />
		<copy file="slc-api.war" todir="${tomcat-dir}/webapps" failonerror="false" />
		<echo message="Altering context.xml userid and password" />
		<replace file="${tomcat-dir}/conf/context.xml" token="username=&quot;qat&quot;" value="username=&quot;${user_id}&quot;" />
		<replace file="${tomcat-dir}/conf/context.xml" token="password=&quot;qat&quot;" value="password=&quot;${user_pass}&quot;" />
	</target>

	<target name="install-all" depends="stop-tomcat, install-tomcat, copy-war, start-tomcat, verify-tomcat-started" />

</project>


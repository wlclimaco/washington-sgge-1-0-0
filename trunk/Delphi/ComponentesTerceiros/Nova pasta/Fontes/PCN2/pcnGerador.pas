////////////////////////////////////////////////////////////////////////////////
//                                                                            //
//              PCN - Projeto Cooperar NFe                                    //
//                                                                            //
//   Descrição: Classes para geração/leitura dos arquivos xml da NFe          //
//                                                                            //
//        site: www.projetocooperar.org/nfe                                   //
//       email: projetocooperar@zipmail.com.br                                //
//       forum: http://br.groups.yahoo.com/group/projeto_cooperar_nfe/        //
//     projeto: http://code.google.com/p/projetocooperar/                     //
//         svn: http://projetocooperar.googlecode.com/svn/trunk/              //
//                                                                            //
// Coordenação: (c) 2009 - Paulo Casagrande                                   //
//                                                                            //
//      Equipe: Vide o arquivo leiame.txt na pasta raiz do projeto            //
//                                                                            //
// Desenvolvimento                                                            //
//         de Cte: Wiliam Zacarias da Silva Rosa                              //
//                                                                            //
//                                                                            //
//      Versão: Vide o arquivo leiame.txt na pasta raiz do projeto            //
//                                                                            //
//     Licença: GNU Lesser General Public License (GNU LGPL)                  //
//                                                                            //
//              - Este programa é software livre; você pode redistribuí-lo    //
//              e/ou modificá-lo sob os termos da Licença Pública Geral GNU,  //
//              conforme publicada pela Free Software Foundation; tanto a     //
//              versão 2 da Licença como (a seu critério) qualquer versão     //
//              mais nova.                                                    //
//                                                                            //
//              - Este programa é distribuído na expectativa de ser útil,     //
//              mas SEM QUALQUER GARANTIA; sem mesmo a garantia implícita de  //
//              COMERCIALIZAÇÃO ou de ADEQUAÇÃO A QUALQUER PROPÓSITO EM       //
//              PARTICULAR. Consulte a Licença Pública Geral GNU para obter   //
//              mais detalhes. Você deve ter recebido uma cópia da Licença    //
//              Pública Geral GNU junto com este programa; se não, escreva    //
//              para a Free Software Foundation, Inc., 59 Temple Place,       //
//              Suite 330, Boston, MA - 02111-1307, USA ou consulte a         //
//              licença oficial em http://www.gnu.org/licenses/gpl.txt        //
//                                                                            //
//    Nota (1): - Esta  licença  não  concede  o  direito  de  uso  do nome   //
//              "PCN  -  Projeto  Cooperar  NFe", não  podendo o mesmo ser    //
//              utilizado sem previa autorização.                             //
//                                                                            //
//    Nota (2): - O uso integral (ou parcial) das units do projeto esta       //
//              condicionado a manutenção deste cabeçalho junto ao código     //
//                                                                            //
////////////////////////////////////////////////////////////////////////////////

{$I ACBr.inc}

unit pcnGerador;

interface uses

  SysUtils, Classes,
{$IFNDEF VER130}
  Variants,
{$ENDIF}
  pcnAuxiliar, pcnConversao;

type

  TGeradorOpcoes = class;

  TGerador = class(TPersistent)
  private
    FArquivoFormatoXML: AnsiString;
    FArquivoFormatoTXT: AnsiString;
    FLayoutArquivoTXT: TstringList;
    FListaDeAlertas: TStringList;
    FTagNivel: string;
    FIDNivel: string;
    FOpcoes: TGeradorOpcoes;
    FPrefixo : string;
  public
    FIgnorarTagNivel: string;
    FIgnorarTagIdentacao: string;
    constructor Create;
    destructor Destroy; override;
    function SalvarArquivo(const CaminhoArquivo: string; const FormatoGravacao: TpcnFormatoGravacao = fgXML): Boolean;
    procedure wGrupo(const TAG: string; ID: string = ''; const Identar: Boolean = True);
    procedure wCampo(const Tipo: TpcnTipoCampo; ID, TAG: string; const min, max, ocorrencias: smallint; const valor: variant; const Descricao: string = '');
    procedure wGrupoNFSe(const TAG: string; ID: string = ''; const Identar: Boolean = True);
    procedure wCampoNFSe(const Tipo: TpcnTipoCampo; ID, TAG: string; const min, max, ocorrencias: smallint; const valor: variant; const Descricao: string = '');
    procedure wCampoCNPJCPF(const ID1, ID2: string; CNPJCPF: string; const cPais: Integer);
    procedure wCampoCNPJ(const ID: string; CNPJ: string; const cPais: Integer; obrigatorio: Boolean);
    procedure wCampoCPF(const ID: string; CPF: string; const cPais: Integer; obrigatorio: Boolean);
    procedure wAlerta(const ID, TAG, Descricao, Alerta: string);
    procedure wTexto(const Texto: string);
    procedure gtNivel(ID: string);
    procedure gtCampo(const Tag, ConteudoProcessado: string);
    procedure gtAjustarRegistros(const ID: string);
  published
    property ArquivoFormatoXML: AnsiString read FArquivoFormatoXML write FArquivoFormatoXML;
    property ArquivoFormatoTXT: AnsiString read FArquivoFormatoTXT write FArquivoFormatoTXT;
    property IDNivel: string read FIDNivel write FIDNivel;
    property ListaDeAlertas: TStringList read FListaDeAlertas write FListaDeAlertas;
    property LayoutArquivoTXT: TStringList read FLayoutArquivoTXT write FLayoutArquivoTXT;
    property Opcoes: TGeradorOpcoes read FOpcoes write FOpcoes;
    property Prefixo: string read FPrefixo write FPrefixo;
  end;

  TGeradorOpcoes = class(TPersistent)
  private
    FSomenteValidar: boolean;
    FIdentarXML: boolean;
    FRetirarEspacos: boolean;
    FRetirarAcentos: boolean;
    FNivelIdentacao: integer;
    FTamanhoIdentacao: integer;
    FSuprimirDecimais: boolean;
    FTagVaziaNoFormatoResumido: boolean;
    FFormatoAlerta: string;
  published
    property SomenteValidar: boolean read FSomenteValidar write FSomenteValidar;
    property RetirarEspacos: boolean read FRetirarEspacos write FRetirarEspacos;
    property RetirarAcentos: boolean read FRetirarAcentos write FRetirarAcentos;
    property IdentarXML: boolean read FIdentarXML write FIdentarXML;
    property TamanhoIdentacao: integer read FTamanhoIdentacao write FTamanhoIdentacao;
    property SuprimirDecimais: boolean read FSuprimirDecimais write FSuprimirDecimais;
    property TagVaziaNoFormatoResumido: boolean read FTagVaziaNoFormatoResumido write FTagVaziaNoFormatoResumido;
    property FormatoAlerta: string read FFormatoAlerta write FFormatoAlerta;
  end;

const

  ERR_MSG_MAIOR = 'Tamanho maior que o máximo permitido';
  ERR_MSG_MENOR = 'Tamanho menor que o mínimo permitido';
  ERR_MSG_VAZIO = 'Nenhum valor informado';
  ERR_MSG_INVALIDO = 'Conteúdo inválido';
  ERR_MSG_MAXIMO_DECIMAIS = 'Numero máximo de casas decimais permitidas';
  ERR_MSG_MAIOR_MAXIMO = 'Número de ocorrências maior que o máximo permitido - Máximo ';
  ERR_MSG_GERAR_CHAVE = 'Erro ao gerar a chave da NFe!';
  ERR_MSG_FINAL_MENOR_INICIAL = 'O numero final não pode ser menor que o inicial';
  ERR_MSG_ARQUIVO_NAO_ENCONTRADO = 'Arquivo não encontrado';
  ERR_MSG_SOMENTE_UM = 'Somente um campo deve ser preenchido';
 // Incluido por Italo em 18/07/2012
  ERR_MSG_MENOR_MINIMO = 'Número de ocorrências menor que o mínimo permitido - Mínimo ';

  CODIGO_BRASIL = 1058;

  ENCODING_UTF8 = '?xml version="1.0" encoding="UTF-8"?';
  ENCODING_UTF8_STD = '?xml version="1.0" encoding="UTF-8" standalone="no"?';
  NAME_SPACE = 'xmlns="http://www.portalfiscal.inf.br/nfe"';
  NAME_SPACE_CTE = 'xmlns="http://www.portalfiscal.inf.br/cte"';
  NAME_SPACE_CFE = 'xmlns="http://www.fazenda.sp.gov.br/sat"';
  NAME_SPACE_MDFE = 'xmlns="http://www.portalfiscal.inf.br/mdfe"';

  V0_02 = 'versao="0.02"';
  V1_00 = 'versao="1.00"';
  V1_01 = 'versao="1.01"';
  V1_02 = 'versao="1.02"';
  V1_03 = 'versao="1.03"';
  V1_04 = 'versao="1.04"';
  V1_07 = 'versao="1.07"';
  V1_10 = 'versao="1.10"';
  V2_00 = 'versao="2.00"';
  V2_01 = 'versao="2.01"';

  VM_Rodo_1_04  = 'versaoModal="1.04"';
  VM_Aereo_1_04 = 'versaoModal="1.04"';
  VM_Aqua_1_04  = 'versaoModal="1.04"';
  VM_Ferro_1_04 = 'versaoModal="1.04"';
  VM_Duto_1_04  = 'versaoModal="1.04"';

  // NFE //

  DSC_AAMM = 'Ano e Mês';
  DSC_ANOFAB = 'Ano de Fabricação';
  DSC_ANOMOD = 'Ano do Modelo de Fabricação';
  DSC_CCOR = 'Cor do Veículo';
  DSC_CDV = 'Digito Verificador';
  DSC_CEAN = 'Código de Barra do Item';
  DSC_CEANTRIB = 'Código de Barra do Item Tributação';
  DSC_CENQ = 'Código de Enquadramento Legal do IPI';
  DSC_CEP = 'CEP';
  DSC_CEXPORTADOR = 'Código do exportador';
  DSC_CFABRICANTE = 'Fabricante';
  DSC_CFOP = 'CFOP';
  DSC_CHASSI = 'Número do chassi';
  DSC_CHAVE = 'Chave da NFe';
  DSC_CLENQ = 'Classe de enquadramento do IPI para Cigarros e Bebidas';
  DSC_CLISTSERV = 'Lista Prestação de Serviços';
  DSC_CSITTRIB = 'Código de Tributação do ISSQN';
  DSC_CILIN = 'Cilindradas';
  DSC_CMT = 'Capacidade Máxima de Tração';
  DSC_CMOD = 'Modelo do Veículo';
  DSC_CCORDEN = 'Código da Cor DENATRAN';
  DSC_TPREST = 'Restrição';
  DSC_CMUN = 'Código do Município';
  DSC_CMUNFG = 'Código do Município FG';
  DSC_CNAE = 'Classificação Nacional de Atividades Econômicas';
  DSC_CRT = 'Código de Regime Tributário';
  DSC_CNF = 'Número da Nota Fiscal Eletrônica';
  DSC_CODIF = 'Código de autorização / registro do CODIF';
  DSC_CONDVEIC = 'Condições do Veículo';
  DSC_CPAIS = 'Código do País';
  DSC_CNPJPROD = 'CNPJ do produtor da mercadoria, quando diferente do emitente';
  DSC_CPROD = 'Código do produto ou serviço';
  DSC_CPRODANP = 'Código do produto ANP';
  DSC_CSELO = 'Código do selo';
  DSC_CST = 'Código da situação tributária ';
  DSC_CSOSN = 'Código de Situação da Operação  Simples Nacional';
  DSC_CUF = 'Código do UF (Unidade da Federação)';
  DSC_DDESEMB = 'Data do Desembaraço Aduaneiro';
  DSC_DDI = 'Data de registro da DI/DSI/DA';
  DSC_DEMI = 'Data de emissão';
  DSC_DESCR = 'Descrição completa';
  DSC_DFAB = 'Data de fabricação';
  DSC_DIST = 'Distância entre os eixos';
  DSC_DPAG = 'Data de pagamento do Documento de Arrecadação';
  DSC_DSAIENT = 'Data de saída ou entrada da mercadoria/produto';
  DSC_HSAIENT = 'Hora de saída ou entrada da mercadoria/produto';
  DSC_DVAL = 'Data de validade';
  DSC_DVENC = 'Data de vencimento';
  DSC_ESP = 'Espécie dos volumes transportados';
  DSC_ESPVEIC = 'Espécie de veículo';
  DSC_EXTIPI = 'EX_TIPI';
  DSC_FINNFE = 'Finalidade de emissão da NFe';
  DSC_FONE = 'Telefone';
  DSC_GENERO = 'Gênero do produto ou serviço';
  DSC_IE = 'Inscrição Estadual';
  DSC_IEST = 'Inscrição Estadual do Substituto tributário';
  DSC_IM = 'Inscrição Municipal';
  DSC_INDPAG = 'Indicador da forma de pagamento';
  DSC_INDPROC = 'Indicador da origem do processo';
  DSC_INFADFISCO = 'Informações adicionais de interesse do Fisco';
  DSC_INFADPROD = 'Informações adicionais do Produto';
  DSC_INFCPL = 'Informações complementares de interesse do contribuinte';
  DSC_ISUF = 'Inscrição na SUFRAMA';
  DSC_EMAIL = 'Endereço de Email';
  DSC_IPITrib = 'IPI Tributável';
  DSC_MARCA = 'Marca dos volumes transportados';
  DSC_MATR = 'Matrícula do agente';
  DSC_MOD = 'Modelo';
  DSC_NECF = 'Número de ordem seqüencial do ECF';
  DSC_NCOO = 'Número do Contador de Ordem de Operação - COO';
  DSC_MODBC = 'Modalidade de determinação da BC do ICMS';
  DSC_MODBCST = 'Modalidade de determinação da BC do ICMS ST';
  DSC_MOTDESICMS = 'Motivo da desoneração do ICMS';
  DSC_MODFRETE = 'Modalidade do Frete';
  DSC_NADICAO = 'Numero da Adição';
  DSC_NATOP = 'Descrição da Natureza da Operação';
  DSC_DHCONT = 'Data e Hora de entrada em contingencia';
  DSC_XJUSTCONT = 'Justificativa de entrada em contingencia';
  DSC_NCANO = 'Numero de série do cano';
  DSC_NCM = 'Código NCM';
  DSC_NDI = 'Numero do Documento de Importação DI/DSI/DA';
  DSC_nDAR = 'Número do Documento Arrecadação de Receita';
  DSC_NDUP = 'Número da duplicata';
  DSC_NFAT = 'Número da fatura';
  DSC_NITEM = 'Numero do item';
  DSC_NLACRE = 'Número dos Lacres';
  DSC_NLOTE = 'Número do Lote do medicamento';
  DSC_NMOTOR = 'Número de Motor';
  DSC_NNF = 'Número do Documento Fiscal';
  DSC_NPROC = 'Identificador do processo ou ato concessório';
  DSC_NRO = 'Número';
  DSC_NSEQADIC = 'Numero seqüencial do item dentro da adição';
  DSC_NSERIE = 'Número de série';
  DSC_NVOL = 'Numeração dos volumes transportados';
  DSC_ORIG = 'Origem da mercadoria';
  DSC_OBSCONT = 'Observações de interesse do contribuite';
  DSC_OBSFISCO = 'Observações de interesse do fisco';
  DSC_PCOFINS = 'Alíquota da COFINS (em percentual)';
  DSC_PESOB = 'Peso Bruto (em kg)';
  DSC_PESOL = 'Peso Líquido (em kg)';
  DSC_PICMS = 'Alíquota do imposto';
  DSC_PICMSRET = 'Alíquota da Retenção';
  DSC_PICMSST = 'Alíquota do imposto do ICMS ST';
  DSC_PIPI = 'Alíquota do IPI';
  DSC_PISOUTR = 'Grupo PIS outras operações';
  DSC_PLACA = 'Placa do Veículo';
  DSC_PMVAST = 'Percentual da margem de valor Adicionado do ICMS ST';
  DSC_POT = 'Potência Motor';
  DSC_PPIS = 'Alíquota do PIS (em percentual)';
  DSC_PREDBC = 'Percentual da Redução de BC';
  DSC_PCREDSN = 'Alíquota aplicável de cálculo do crédito (Simples Nacional).';
  DSC_VCREDICMSSN = 'Valor crédito do ICMS que pode ser aproveitado nos termos do art. 23 da LC 123 (Simples Nacional)';
  DSC_PREDBCST = 'Percentual da Redução de BC do ICMS ST';
  DSC_UFST = 'UF para qual é devido o ICMS ST';
  DSC_PBCOP = 'Percentual da BC operação própria';
  DSC_PROCEMI = 'Processo de emissão da NF-e';
  DSC_QBCPROD = 'BC da CIDE';
  DSC_QCOM = 'Quantidade Comercial';
  DSC_QLOTE = 'Quantidade de produto no Lote do medicamento';
  DSC_QSELO = 'Quantidade de selo de controle';
  DSC_QTEMP = 'Quantidade de combustível faturada à temperatura ambiente.';
  DSC_QTRIB = 'Quantidade Tributável';
  DSC_QUNID = 'Quantidade total na unidade padrão para tributação (somente para os produtos tributados por unidade)';
  DSC_QVOL = 'Quantidade de volumes transportados';
  DSC_REBOQUE = 'Reboque';
  DSC_REFNFE = 'Chave de acesso das NF-e referenciadas';
  DSC_RENAVAM = 'RENAVAM';
  DSC_REPEMI = 'Repartição Fiscal emitente';
  DSC_RNTC = 'Registro Nacional de Transportador de Carga (ANTT)';
  DSC_VAGAO = 'Identificação do vagão';
  DSC_BALSA = 'Identificação da balsa';
  DSC_SERIE = 'Série do Documento Fiscal';
  DSC_TPAMB = 'Identificação do Ambiente';
  DSC_TPARMA = 'Indicador do tipo de arma de fogo';
  DSC_TPCOMB = 'Tipo de combustível';
  DSC_TPEMIS = 'Forma de Emissão da NF-e';
  DSC_TPIMP = 'Formato de Impressão do DANFE';
  DSC_TPNF = 'Tipo do Documento Fiscal';
  DSC_TPOP = 'Tipo da operação';
  DSC_TPPINT = 'Tipo de Pintura';
  DSC_TPVEIC = 'Tipo de Veículo';
  DSC_UCOM = 'Unidade Comercial';
  DSC_UF = 'Sigla da UF';
  DSC_UFCONS = 'Sigla da UF de consumo';
  DSC_UFDESEMB = 'Sigla da UF onde ocorreu o Desembaraço Aduaneiro';
  DSC_UFEMBARQ = 'Sigla da UF onde ocorrerá o embarque dos produtos';
  DSC_UTRIB = 'Unidade Tributável';
  DSC_VALIQ = 'Alíquota';
  DSC_VALIQPROD = 'Valor da alíquota (em reais)';
  DSC_VBC = 'Valor da BC do ICMS';
  DSC_VBCICMS = 'BC do ICMS';
  DSC_VBCICMSST = 'BC do ICMS ST retido';
  DSC_VBCICMSSTCONS = 'Valor do ICMS ST da UF de consumo';
  DSC_VBCICMSSTDEST = 'BC do ICMS ST da UF de destino';
  DSC_VBCIRRF = 'Base de Cálculo do IRRF';
  DSC_VBCRET = 'BC da Retenção do ICMS';
  DSC_VBCRETPREV = 'Base de Cálculo da Retenção da Previdência Social';
  DSC_VBCST = 'Valor da BC do ICMS ST';
  DSC_VBCSTRET = 'Valor da BC do ICMS ST Retido';
  DSC_VCIDE = 'Valor da CIDE';
  DSC_VCOFINS = 'Valor do COFINS';
  DSC_VDAR = 'Valor total constante no Documento de arrecadação de Receita';
  DSC_VDESC = 'Valor do desconto';
  DSC_INDTOT = 'Indicador de soma no total da NFe';
  DSC_VDESCDI = 'Valor do desconto do item da DI  adição';
  DSC_NITEMPED = 'Item do Pedido de Compra da DI  adição';
  DSC_VDESPADU = 'Valor das despesas aduaneiras';
  DSC_VDUP = 'Valor da duplicata';
  DSC_VERPROC = 'Versão do Processo de emissão da NF-e';
  DSC_VFRETE = 'Valor Total do Frete';
  DSC_VICMS = 'Valor do ICMS';
  DSC_VICMSRET = 'Valor do ICMS Retido';
  DSC_VICMSST = 'Valor do ICMS Substituição Tributaria';
  DSC_VICMSSTRET = 'Valor do ICMS Substituição Tributaria Retido';
  DSC_VICMSSTCONS = 'Valor do ICMS Substituição Tributaria da UF de Consumo';
  DSC_VICMSSTDEST = 'Valor do ICMS Substituição Tributaria da UF de Destino';
  DSC_VII = 'Valor do Imposto de Importação';
  DSC_VIN = 'Condição do VIN';
  DSC_VIOF = 'Valor do Imposto sobre operações Financeiras';
  DSC_vIPI = 'Valor do Imposto sobre Produtos Industrializados';
  DSC_VIRRF = 'Valor do Imposto de Renda Retido na Fonte';
  DSC_VBCISS = 'Valor da Base de Cálculo do ISSQN';
  DSC_VISS = 'Valor do Imposto sobre Serviço';
  DSC_VISSQN = 'Valor do Imposto sobre Serviço de Qualquer Natureza';
  DSC_VLIQ = 'Valor Líquido da Fatura';
  DSC_VNF = 'Valor Total da NF-e';
  DSC_VORIG = 'Valor Original da Fatura';
  DSC_VOUTRO = 'Outras Despesas Acessórias';
  DSC_VPIS = 'Valor do PIS';
  DSC_VPMC = 'Preço Máximo ao Consumidor';
  DSC_VPROD = 'Valor Total Bruto dos Produtos ou Serviços';
  DSC_VRETCOFINS = 'Valor Retido do COFINS';
  DSC_VRETCSLL = 'Valor Retido da CONTRIBUIÇÃO SOCIAL SOBRE O LUCRO LÍQUIDO';
  DSC_VRETPIS = 'Valor Retido do PIS';
  DSC_VRETPREV = 'Valor da Retenção da Previdência Social';
  DSC_VSEG = 'Valor Total do Seguro';
  DSC_VSERV = 'Valor total dos Serviços sob não incidência ou não Tributados pelo ICMS  / Valor do Serviço';
  DSC_VST = 'Valor TOTAL Icms substituição Tributária';
  DSC_VUNCOM = 'Valor Unitário de Comercialização';
  DSC_VUNID = 'Valor por Unidade Tributável';
  DSC_VUNTRIB = 'Valor unitário de Tributação';
  DSC_XAGENTE = 'Nome do agente';
  DSC_XBAIRRO = 'Bairro';
  DSC_XCAMPO = 'Identificação do Campo';
  DSC_XCONT = 'Contrato';
  DSC_XCOR = 'Descrição da Cor';
  DSC_XCPL = 'Complemento (Endereço)';
  DSC_XENDER = 'Endereço Completo';
  DSC_XFANT = 'Nome de Fantasia';
  DSC_XLGR = 'Logradouro';
  DSC_XLOCDESEMB = 'Local de Desembaraço';
  DSC_XLOCEMBARQ = 'Local onde ocorrerá o embarque dos produtos';
  DSC_XMUN = 'Nome do Município';
  DSC_XNEMP = 'Nota de Empenho';
  DSC_XNOME = 'Razão Social ou Nome';
  DSC_XPAIS = 'Nome do País';
  DSC_XPED = 'Pedido';
  DSC_XPROD = 'Descrição do Produto ou Serviço';
  DSC_XTEXTO = 'Conteúdo do Campo';
  DSC_XORGAO = 'Orgão emitente';
  DSC_DigestValue = 'Digest Value';
  DSC_SignatureValue = 'Signature Value';
  DSC_X509Certificate = 'X509 Certificate';
  DSC_XSERV = 'Descrição do serviço';
  DSC_ANO = 'Ano';
  DSC_CNPJ = 'CNPJ(MF)';
  DSC_CPF = 'CPF';
  DSC_NNFINI = 'Numero inicial';
  DSC_NNFFIN = 'Numero final';
  DSC_XJUST = 'Justificativa';
  DSC_CHNFE = 'Chave da NFe';
  DSC_NPROT = 'Numero do protocolo';
  DSC_NREC = 'Numero do recibo';
  DSC_IDLOTE = 'Numero do Lote';
  DSC_VERAPLIC = 'Versão do aplicativo';
  DSC_NREGDPEC = 'Número de registro do DPEC';
  DSC_DPEC_ID = 'Grupo de Identificação da TAG a ser assinada. DPEC + CNPJ do emissor.';
  DSC_SAFRA = 'Identificação da safra';
  DSC_REF = 'Mês e ano de referência';
  DSC_FORDIA = 'Grupo de Fornecimento diário de cana';
  DSC_DIA = 'Dia';
  DSC_QTDE = 'Quantidade';
  DSC_QTOTMES = 'Quantidade Total do Mês';
  DSC_QTOTANT = 'Quantidade Total Anterior';
  DSC_TOTGER = 'Quantidade Total Geral';
  DSC_DEDUC = 'Grupo de Deduções  Taxas e Contribuições';
  DSC_XDED = 'Descrição da Dedução';
  DSC_VDED = 'Valor da Dedução';
  DSC_VFOR = 'Valor dos Fornecimentos';
  DSC_VTOTDED = 'Valor Total da Dedução';
  DSC_VLIQFOR = 'Valor Líquido dos Fornecimentos';
  DSC_INDNFE = 'Indicador de NF-e consultada';
  DSC_INDEMI = 'Indicador do Emissor da NF-e';
  DSC_ULTNSU = 'Último NSU recebido pela Empresa';

  // CTE //
  DSC_CHCTE    = 'Chave do CTe';
  DSC_TPCTe    = 'Tipo do Conhecimento';
  DSC_REFCTE   = 'Chave de acesso do CT-e referenciado';
  DSC_CMUNEMI  = 'Código do Município onde o CT-e está sendo emitido';
  DSC_ORIGCALC = 'Município origem para efeito de cálculo do frete';
  DSC_DESTCALC = 'Município destino para efeito de cálculo do frete';
  DSC_XOBS     = 'Observações Gerais';
  DSC_TOMA     = 'Tomador do Serviço';
  DSC_INFNF    = 'Informações da Nota Fiscal';
  DSC_INFNFE   = 'Informações da Nota Fiscal Eletrônica';
  DSC_NDOC     = 'Número da Nota Fiscal';
  DSC_PESO     = 'Peso';
  DSC_TPDOC    = 'Tipo de documento originário';
  DSC_OUTROS   = 'Descrição';
  DSC_VTPREST  = 'Valor total da prestação do serviço';
  DSC_VREC     = 'Valor a Receber';
  DSC_XNOMEC   = 'Nome do Componente';
  DSC_VCOMP    = 'Valor do Componente';
  DSC_VCRED    = 'Valor do Crédito outorgado/presumido';
  DSC_RESPSEG  = 'Responsável pelo Seguro';
  DSC_XSEG     = 'Nome da Seguradora';
  DSC_NAPOL    = 'Número da Apólice';
  DSC_NAVER    = 'Número da Averbação';
  DSC_VMERC    = 'Valor da mercadoria para efeito de averbação';

  DSC_INFSEG   = 'Informações de seguro da carga';
  DSC_RNTRC    = 'Registro Nacional de Transportadores Rodoviários de Carga';
  DSC_DPREV    = 'Data prevista de entrega';
  DSC_LOTA     = 'Indicador de lotação';
  DSC_CINT     = 'Código interno do emitente';
  DSC_LACR     = 'Grupo de lacres';
  DSC_TPPROP   = 'Tipo de Proprietário';
  DSC_INFOUTRO = 'informações dos demais documentos';
  DSC_VDOC     = 'Valor do documento';
  DSC_MODAL    = 'Tipo de Modal';
  DSC_TPSERV   = 'Tipo do Serviço';
  DSC_RETIRA   = 'Recebedor retira na Filial?';
  DSC_PRED     = 'Produto predominante';
  DSC_OUTCAT   = 'Outras características da carga';
  DSC_VTMERC   = 'Valor total da mercadoria';
  DSC_INFQ     = 'Informações de quantidades da Carga';
  DSC_CUNID    = 'Código da unidade de medida';
  DSC_TPMED    = 'Tipo da Medida';
  DSC_QTD      = 'Quantidade';
  DSC_DRET     = 'Detalhes da Retirada';

  //CFe - Cupom Fiscal Eletrônico - SAT
  DSC_VDESCSUBTOT = 'Valor de Desconto sobre Subtotal';
  DSC_VACRESSUBTOT = 'Valor de Acréscimo sobre Subtotal';
  DSC_VPISST = 'Valor do PIS ST';
  DSC_VCOFINSST = 'Valor do COFINS ST';
  DSC_VCFE = 'Valor Total do CF-e';
  DSC_VCFELEI12741 = 'Valor aproximado dos tributos do CFe-SAT  Lei 12741/12.';
  DSC_VDEDUCISS = 'Valor das deduções para ISSQN';
  DSC_CSERVTRIBMUN = 'Codigo de tributação pelo ISSQN do municipio';
  DSC_CNATOP = 'Natureza da Operação de ISSQN';
  DSC_INDINCFISC = 'Indicador de Incentivo Fiscal do ISSQN';
  DSC_COFINSST = 'Grupo de COFINS Substituição Tributária';
  DSC_REGTRIB = 'Código de Regime Tributário';
  DSC_REGISSQN = 'Regime Especial de Tributação do ISSQN';
  DSC_RATISSQN = 'Indicador de rateio do Desconto sobre subtotal entre itens sujeitos à tributação pelo ISSQN.';
  DSC_NCFE = 'Número do Cupom Fiscal Eletronico';
  DSC_HEMI = 'Hora de emissão';
  DSC_SIGNAC = 'Assinatura do Aplicativo Comercial';
  DSC_QRCODE = 'Assinatura Digital para uso em QRCODE';
  DSC_MP = 'Grupo de informações sobre Pagamento do CFe';
  DSC_CMP = 'Código do Meio de Pagamento';
  DSC_VMP = 'Valor do Meio de Pagamento';
  DSC_CADMC = 'Credenciadora de cartão de débito ou crédito';
  DSC_VTROCO = 'Valor do troco';
  DSC_VITEM = 'Valor líquido do Item';
  DSC_VRATDESC = 'Rateio do desconto sobre subtotal';
  DSC_VRATACR = 'Rateio do acréscimo sobre subtotal';
  DSC_NUMEROCAIXA = 'Número do Caixa ao qual o SAT está conectado';
  DSC_VITEM12741 = 'Valor aproximado dos tributos do Produto ou serviço  Lei 12741/12';

implementation

uses DateUtils, ACBrConsts;

{ TGerador }

constructor TGerador.Create;
begin
  FOpcoes := TGeradorOpcoes.Create;
  FOpcoes.FIdentarXML := False;
  FOpcoes.FTamanhoIdentacao := 3;
  FOpcoes.FFormatoAlerta := 'TAG:%TAGNIVEL% ID:%ID%/%TAG%(%DESCRICAO%) - %MSG%.'; // Vide comentário em wAlerta
  FOpcoes.FRetirarEspacos := True;
  FOpcoes.FRetirarAcentos := True;
  FOpcoes.FSuprimirDecimais := False;
  FOpcoes.FSomenteValidar := False;
  FOpcoes.FTagVaziaNoFormatoResumido := True;
  FListaDeAlertas := TStringList.Create;
  FLayoutArquivoTXT := TStringList.Create;
end;

destructor TGerador.Destroy;
begin
  FOpcoes.Free;
  FListaDeAlertas.Free;
  FLayoutArquivoTXT.Free;
  FIgnorarTagNivel := '!@#';
  FIgnorarTagIdentacao := '!@#';
  inherited Destroy;
end;

function TGerador.SalvarArquivo(const CaminhoArquivo: string; const FormatoGravacao: TpcnFormatoGravacao = fgXML): Boolean;
var
  ArquivoGerado: TStringList;
begin
  // Formato de gravação somente é válido para NFe
  ArquivoGerado := TStringList.Create;
  try
    try
      if FormatoGravacao = fgXML then
        ArquivoGerado.Add(FArquivoFormatoXML)
      else
        ArquivoGerado.Add(FArquivoFormatoTXT);
      ArquivoGerado.SaveToFile(CaminhoArquivo);
      Result := True;
    except
      Result := False;
      raise;
    end;
  finally
    ArquivoGerado.Free;
  end;
end;

procedure TGerador.wAlerta(const ID, TAG, Descricao, Alerta: string);
var
  s: string;
begin
  // O Formato da mensagem de erro pode ser alterado pelo usuario alterando-se a property FFormatoAlerta: onde;
  // %TAGNIVEL%  : Representa o Nivel da TAG; ex: <transp><vol><lacres>
  // %TAG%       : Representa a TAG; ex: <nLacre>
  // %ID%        : Representa a ID da TAG; ex X34
  // %MSG%       : Representa a mensagem de alerta
  // %DESCRICAO% : Representa a Descrição da TAG
  s := FOpcoes.FFormatoAlerta;
  s := stringReplace(s, '%TAGNIVEL%', FTagNivel, [rfReplaceAll]);
  s := stringReplace(s, '%TAG%', TAG, [rfReplaceAll]);
  s := stringReplace(s, '%ID%', ID, [rfReplaceAll]);
  s := stringReplace(s, '%MSG%', Alerta, [rfReplaceAll]);
  s := stringReplace(s, '%DESCRICAO%', Trim(Descricao), [rfReplaceAll]);
  if Trim(Alerta) <> '' then
    FListaDeAlertas.Add(s);
end;

procedure TGerador.wGrupo(const TAG: string; ID: string = ''; const Identar: Boolean = True);
begin
  // A propriedade FIgnorarTagNivel é utilizada para Ignorar TAG
  // na construção dos níveis para apresentação na mensagem de erro.
  gtNivel(ID);
  // Caso a tag seja um Grupo com Atributo
  if (pos('="', TAG) > 0) or (pos('= "', TAG) > 0) then
    gtCampo(RetornarConteudoEntre(TAG, ' ', '='), RetornarConteudoEntre(TAG, '"', '"'));
  //
  if not SubStrEmSubStr(TAG, FIgnorarTagNivel) then
  begin
    if TAG[1] <> '/' then
      FTagNivel := FTagNivel + '<' + TAG + '>';
    if (TAG[1] = '/') and (Copy(TAG, 2, 3) = 'det') then
      FTagNivel := copy(FTagNivel, 1, pos('<det', FTagNivel) - 1)
    else
      FTagNivel := StringReplace(FTagNivel, '<' + Copy(TAG, 2, MaxInt) + '>', '', []);
  end;
  //
  if (Identar) and (TAG[1] = '/') then
    Dec(FOpcoes.FNivelIdentacao);
  if SubStrEmSubStr(TAG, FIgnorarTagIdentacao) then
    Dec(FOpcoes.FNivelIdentacao);
  //
  if FOpcoes.IdentarXML then
    FArquivoFormatoXML := FArquivoFormatoXML + StringOfChar(' ', FOpcoes.FTamanhoIdentacao * FOpcoes.FNivelIdentacao) + '<' + tag + '>' + #13#10
  else
    FArquivoFormatoXML := FArquivoFormatoXML + '<' + tag + '>';
  if (Identar) and (TAG[1] <> '/') then
    Inc(FOpcoes.FNivelIdentacao);
end;

procedure TGerador.wCampoCNPJCPF(const ID1, ID2: string; CNPJCPF: string; const cPais: Integer);
var
  Tamanho: integer;
begin
  if cPais <> 1058 then
  begin
    wCampo(tcStr, ID1, 'CNPJ', 00, 00, 1, '');
    exit;
  end;
  CNPJCPF := SomenteNumeros(trim(CNPJCPF));
  Tamanho := length(CNPJCPF);
  if Tamanho = 11 then
  begin
    wCampo(tcStr, ID2, 'CPF  ', 11, 11, 1, CNPJCPF);
    if not ValidarCPF(CNPJCPF) then
      wAlerta(ID2, 'CPF', 'CPF', ERR_MSG_INVALIDO);
  end
  else if Tamanho = 14 then
  begin
    wCampo(tcStr, ID1, 'CNPJ', 14, 14, 1, CNPJCPF);
    if not ValidarCNPJ(CNPJCPF) then
      wAlerta(ID1, 'CNPJ', 'CNPJ', ERR_MSG_INVALIDO);
  end;
  if ((Tamanho <> 11) and (Tamanho <> 14)) then
    wAlerta(ID1 + '-' + ID2, 'CNPJ-CPF', 'CNPJ/CPF', ERR_MSG_VAZIO);
end;

procedure TGerador.wCampoCNPJ(const ID: string; CNPJ: string; const cPais: Integer; obrigatorio: Boolean);
begin
  if cPais <> 1058 then
  begin
    wCampo(tcStr, ID, 'CNPJ', 00, 00, 1, '');
    exit;
  end;
  CNPJ := SomenteNumeros(trim(CNPJ));
  if obrigatorio then
    wCampo(tcEsp, ID, 'CNPJ', 14, 14, 1, CNPJ, DSC_CNPJ)
  else
    wCampo(tcEsp, ID, 'CNPJ', 14, 14, 0, CNPJ, DSC_CNPJ);
  if not ValidarCNPJ(CNPJ) then
    wAlerta(ID, 'CNPJ', DSC_CNPJ, ERR_MSG_INVALIDO);
end;

procedure TGerador.wCampoCPF(const ID: string; CPF: string; const cPais: Integer; obrigatorio: Boolean);
begin
  if cPais <> 1058 then
  begin
    wCampo(tcStr, ID, 'CPF', 00, 00, 1, '');
    exit;
  end;
  CPF := SomenteNumeros(trim(CPF));
  if obrigatorio then
    wCampo(tcEsp, ID, 'CPF', 11, 11, 1, CPF, DSC_CPF)
  else
    wCampo(tcEsp, ID, 'CPF', 11, 11, 0, CPF, DSC_CPF);
  if not ValidarCPF(CPF) then
    wAlerta(ID, 'CPF', DSC_CPF, ERR_MSG_INVALIDO);
end;

procedure TGerador.wCampo(const Tipo: TpcnTipoCampo; ID, TAG: string; const min, max, ocorrencias: smallint; const valor: variant; const Descricao: string = '');
var
  NumeroDecimais: smallint;
  Limite: Integer;
  alerta, ConteudoProcessado: string;
  wAno, wMes, wDia, wHor, wMin, wSeg, wMse: Word;
  EstaVazio: boolean;
begin
  ID                  := Trim(ID);
  Tag                 := Trim(TAG);
  EstaVazio           := False;
  NumeroDecimais      := 0;
  ConteudoProcessado  := '';
  Limite              := max;
  case Tipo of
    tcStr   : begin
                ConteudoProcessado := trim(valor);
                EstaVazio := ConteudoProcessado = '';

              end;
    tcDat,
    tcDatCFe: begin
                DecodeDate(valor, wAno, wMes, wDia);
                ConteudoProcessado := FormatFloat('0000', wAno) + '-' + FormatFloat('00', wMes) + '-' + FormatFloat('00', wDia);
                if Tipo = tcDatCFe then
                  ConteudoProcessado := SomenteNumeros(ConteudoProcessado);
                EstaVazio := ((wAno = 1899) and (wMes = 12) and (wDia = 30));
              end;
    tcHor,
    tcHorCFe: begin
                DecodeTime(valor, wHor, wMin, wSeg, wMse);
                ConteudoProcessado := FormatFloat('00', wHor) + ':' + FormatFloat('00', wMin) + ':' + FormatFloat('00', wSeg);
                if Tipo = tcHorCFe then
                   ConteudoProcessado := SomenteNumeros(ConteudoProcessado);
                EstaVazio := (wHor = 0) and (wMin = 0) and (wSeg = 0);
              end;
    tcDatHor : begin
                DecodeDateTime(valor, wAno, wMes, wDia, wHor, wMin, wSeg, wMse);
                ConteudoProcessado := FormatFloat('0000', wAno) + '-' +
                FormatFloat('00', wMes) + '-' +
                FormatFloat('00', wDia) + 'T' +
                FormatFloat('00', wHor) + ':' +
                FormatFloat('00', wMin) + ':' +
                FormatFloat('00', wSeg);
                EstaVazio := ((wAno = 1899) and (wMes = 12) and (wDia = 30));
              end;
      tcDe2,
      tcDe3,
      tcDe4,
      tcDe6,  // Incluido por Italo em 30/09/2010
      tcDe10 : begin
                // adicionar um para que o máximo não considere a virgula
                Limite := Limite + 1;

                // Tipo numerico com decimais
                  case Tipo of
                    tcDe2 : NumeroDecimais :=  2;
                    tcDe3 : NumeroDecimais :=  3;
                    tcDe4 : NumeroDecimais :=  4;
                    tcDe6 : NumeroDecimais :=  6; // Incluido por Italo em 30/09/2010
                    tcDe10: NumeroDecimais := 10;
                  end;
                  ConteudoProcessado  := FormatFloat('0.0000000000', valor);
                  EstaVazio           := (valor = 0) and (ocorrencias = 0);
                  if StrToIntDef(Copy(ConteudoProcessado, pos(DecimalSeparator, ConteudoProcessado) + NumeroDecimais + 1, 10),0) > 0 then
                    walerta(ID, Tag, Descricao, ERR_MSG_MAXIMO_DECIMAIS + ' ' + IntToStr(NumeroDecimais));

                  ConteudoProcessado := FormatFloat('0.' + StringOfChar('0', NumeroDecimais), valor);
                  ConteudoProcessado := StringReplace(ConteudoProcessado, ',', '.', [rfReplaceAll]);
                  // Caso não seja um valor fracionário; retira os decimais.
                  if FOpcoes.FSuprimirDecimais then
                    if int(Valor) = Valor then
                     ConteudoProcessado := IntToStr(Round(Integer(valor)));

              end;
      tcEsp : begin
                  // Tipo String - somente numeros
                  ConteudoProcessado  := trim(valor);
                  EstaVazio           := valor = '';
                  if not ValidarNumeros(ConteudoProcessado) then walerta(ID, Tag, Descricao, ERR_MSG_INVALIDO);
              end;
      tcInt : begin
                  // Tipo Inteiro
                  ConteudoProcessado := IntToStr(valor);
                  EstaVazio := (valor = 0) and (ocorrencias = 0);
                  if min = Limite then
                  begin
                    ConteudoProcessado := StringOfChar('0', 60) + ConteudoProcessado;
                    ConteudoProcessado := copy(ConteudoProcessado, length(ConteudoProcessado) - Limite + 1, Limite);
                  end;
              end;
    end;
    alerta := '';
    //(Existem tags obrigatórias que podem ser nulas ex. cEAN)  if (ocorrencias = 1) and (EstaVazio) then
    if (ocorrencias = 1) and (EstaVazio) and (min > 0)                                            then alerta := ERR_MSG_VAZIO;
    if (length(ConteudoProcessado) < min) and (alerta = '') and (length(ConteudoProcessado) > 1)  then alerta := ERR_MSG_MENOR;
    if length(ConteudoProcessado) > Limite                                                        then alerta := ERR_MSG_MAIOR;
      // Grava alerta //
    if (alerta <> '') and (pos(ERR_MSG_VAZIO, alerta) = 0) and (not EstaVazio)                    then alerta := alerta + ' [' + VarToStr(valor) + ']';
    walerta(ID, TAG, Descricao, alerta);
    // Sai se for apenas para validar //
    if FOpcoes.FSomenteValidar  then exit;
    // Grava no Formato Texto
    if not EstaVazio            then
      gtCampo(tag, ConteudoProcessado)
    else
      gtCampo(tag, '');

    // Grava a tag no arquivo - Quando não existir algum conteúdo
    if ((ocorrencias = 1) and (EstaVazio)) then
    begin
      if FOpcoes.FIdentarXML then
      begin
        if FOpcoes.FTagVaziaNoFormatoResumido then
          FArquivoFormatoXML := FArquivoFormatoXML + StringOfChar(' ', FOpcoes.FTamanhoIdentacao * FOpcoes.FNivelIdentacao) + '<' + tag + '/>' + #13#10
        else
          FArquivoFormatoXML := FArquivoFormatoXML + StringOfChar(' ', FOpcoes.FTamanhoIdentacao * FOpcoes.FNivelIdentacao) + '<' + tag + '></' + tag + '>' + #13#10
      end
      else
      begin
        if FOpcoes.FTagVaziaNoFormatoResumido then
          FArquivoFormatoXML := FArquivoFormatoXML + '<' + tag + '/>'
        else
          FArquivoFormatoXML := FArquivoFormatoXML + '<' + tag + '></' + tag + '>';
      end;
      exit;
    end;
    // Grava a tag no arquivo - Quando existir algum conteúdo
    if ((ocorrencias = 1) or (not EstaVazio)) then
      if FOpcoes.FIdentarXML then
        FArquivoFormatoXML := FArquivoFormatoXML + StringOfChar(' ', FOpcoes.FTamanhoIdentacao * FOpcoes.FNivelIdentacao) + '<' + tag + '>' + FiltrarTextoXML(FOpcoes.FRetirarEspacos, ConteudoProcessado, FOpcoes.FRetirarAcentos) + '</' + tag + '>' + #13#10
    else
      FArquivoFormatoXML := FArquivoFormatoXML + '<' + tag + '>' + FiltrarTextoXML(FOpcoes.FRetirarEspacos, ConteudoProcessado, FOpcoes.FRetirarAcentos) + '</' + tag + '>';
end;

procedure TGerador.wTexto(const Texto: string);
begin
  FArquivoFormatoXML := FArquivoFormatoXML + Texto;
end;

// Gerador TXT

procedure TGerador.gtNivel(ID: string);
var
  i: integer;
begin
  ID := UpperCase(ID);
  FIDNivel := ID;
  if (FLayoutArquivoTXT.Count = 0) or (ID = '') then
    exit;
  for i := 0 to FLayoutArquivoTXT.Count - 1 do
    if pos('<' + ID + '>', UpperCase(FLayoutArquivoTXT.Strings[i])) > 0 then
      FArquivoFormatoTXT := FArquivoFormatoTXT + FLayoutArquivoTXT.Strings[i] + #13;
end;

procedure TGerador.gtCampo(const Tag, ConteudoProcessado: string);
var
  i: integer;
  List: TstringList;
begin
  if FLayoutArquivoTXT.Count = 0 then
    exit;
  List := TStringList.Create;
  List.Text := FArquivoFormatoTXT;
  //
  for i := 0 to List.count - 1 do
    if pos('<' + FIDNivel + '>', List.Strings[i]) > 0 then
      if pos('|' + UpperCase(Tag) + '¨', UpperCase(List.Strings[i])) > 0 then
        List[i] := StringReplace(List[i], '|' + UpperCase(Trim(TAG)) + '¨', '|' + conteudoProcessado, []);
  //
  FArquivoFormatoTXT := List.Text;
  List.Free;
end;

procedure TGerador.gtAjustarRegistros(const ID: string);
var
  i, j, k: integer;
  s, idLocal: string;
  ListArquivo: TstringList;
  ListCorrigido: TstringList;
  ListTAGs: TstringList;
begin
  if FLayoutArquivoTXT.Count = 0 then
    exit;
  ListTAGs := TStringList.Create;
  ListArquivo := TStringList.Create;
  ListCorrigido := TStringList.Create;
  // Elimina registros não utilizados
  ListArquivo.Text := FArquivoFormatoTXT;
  for i := 0 to ListArquivo.count - 1 do
  begin
    k := 0;
    for j := 0 to FLayoutArquivoTXT.count - 1 do
      if listArquivo[i] = FLayoutArquivoTXT[j] then
        if pos('¨', listArquivo[i]) > 0 then
          k := 1;
    if k = 0 then
      ListCorrigido.add(ListArquivo[i]);
  end;
  // Insere dados da chave da Nfe
  for i := 0 to ListCorrigido.count - 1 do
    if pos('^ID^', ListCorrigido[i]) > 1 then
      ListCorrigido[i] := StringReplace(ListCorrigido[i], '^ID^', ID, []);
  // Elimina Nome de TAG sem informação
  for j := 0 to FLayoutArquivoTXT.count - 1 do
  begin
    s := FLayoutArquivoTXT[j];
    while (pos('|', s) > 0) and (pos('¨', s) > 0) do
    begin
      s := copy(s, pos('|', s), maxInt);
      ListTAGs.add(copy(s, 1, pos('¨', s)));
      s := copy(s, pos('¨', s) + 1, maxInt);
    end;
  end;
  for i := 0 to ListCorrigido.count - 1 do
    for j := 0 to ListTAGs.count - 1 do
      ListCorrigido[i] := StringReplace(ListCorrigido[i], ListTAGs[j], '|', []);
  // Elimina Bloco <ID>
  for i := 0 to ListCorrigido.count - 1 do
    if pos('>', ListCorrigido[i]) > 0 then
     begin
      ListCorrigido[i] := Trim(copy(ListCorrigido[i], pos('>', ListCorrigido[i]) + 1, maxInt));
      idLocal := copy(ListCorrigido[i],1,pos('|',ListCorrigido[i])-1);

      if (length(idLocal) > 2) and (UpperCase(idLocal) <> 'NOTA FISCAL') and
         (copy(idLocal,length(idLocal),1) <> SomenteNumeros(copy(idLocal,length(idLocal),1))) then
       begin
         idLocal := copy(idLocal,1,length(idLocal)-1)+LowerCase(copy(idLocal,length(idLocal),1));
         ListCorrigido[i] := StringReplace(ListCorrigido[i],idLocal,idLocal,[rfIgnoreCase]);
       end;
     end;
  FArquivoFormatoTXT := ListCorrigido.Text;
  //
  ListTAGs.Free;
  ListArquivo.Free;
  ListCorrigido.Free;
end;

procedure TGerador.wCampoNFSe(const Tipo: TpcnTipoCampo; ID, TAG: string;
  const min, max, ocorrencias: smallint; const valor: variant;
  const Descricao: string);
begin
  Self.wCampo(Tipo, ID, Self.Prefixo + TAG, min, max, ocorrencias, valor, Descricao);
end;

procedure TGerador.wGrupoNFSe(const TAG: string; ID: string;
  const Identar: Boolean);
begin
  if copy(TAG,1,1) = '/' then
     Self.wGrupo('/'+Self.Prefixo + copy(TAG,2,length(TAG)), ID, Identar)
  else
     Self.wGrupo(Self.Prefixo + TAG, ID, Identar);
end;

end.


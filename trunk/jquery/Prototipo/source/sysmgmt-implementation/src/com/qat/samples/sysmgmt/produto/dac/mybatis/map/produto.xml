<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ProdutoMap">


  <!-- Result maps describe the mapping between the columns returned
       from a query, and the class properties.  A result map isn't
       necessary if the columns (or aliases) match to the properties
       exactly. produtoid, codbarra, nome, marca, menu, submenu, trimenu, unimed,
            precoid, controleid, foto, supermercadoid-->
  <resultMap id="ProdutoResult" type="Produto">
    <result property="id" column="produtoid"/>
    <result property="codBarra" column="codbarra"/>
    <result property="nome" column="nome"/>
    <result property="descricao" column="descricao"/>
    <result property="foto" column="foto"/>
    <association property="marca" column="marca" javaType="Cadastro" select="fetchMarcaByCode" />
    <association property="menu" column="menu" javaType="Cadastro" select="fetchMenuByCode" />
    <association property="embalagem" column="embalagem" javaType="Embalagem" select="fetchUniMedByEmbalagem" />
    <collection property="precos" column="produtoid" select="PrecoMap.fetchPrecoByProduto" />
    <collection property="acessos" column="produtoid" select="ControleAcessMap.fetchControleAcessByProduto" />
  </resultMap>

  <resultMap id="ProdutoResult2" type="Produto">
    <result property="id" column="produtoid"/>
    <result property="codBarra" column="codbarra"/>
    <result property="nome" column="nome"/>
    <result property="descricao" column="descricao"/>
    <result property="foto" column="foto"/>
    <association property="marca" column="marca" javaType="Cadastro" select="fetchMarcaByCode" />
    <association property="menu" column="menu" javaType="Cadastro" select="fetchMenuByCode" />
    <association property="embalagem" column="embalagem" javaType="Embalagem" select="fetchUniMedByEmbalagem" />
    <collection property="acessos" column="produtoid" select="ControleAcessMap.fetchControleAcessByProduto" />
  </resultMap>

   <resultMap id="CadastroResult" type="Cadastro">
    <result property="id" column="cadastroid"/>
    <result property="tableTypeEnumValue" column="acao"/>
    <result property="nome" column="nome"/>
    <result property="descricao" column="descricao"/>
    <result property="controleid" column="controleid"/>
    <association property="produtos" column="cadastroid" javaType="Integer" select="fetchCountProduto"/>
    <collection property="acessos" column="cadastroid" select="ControleAcessMap.fetchControleAcessByCadastro" />
  </resultMap>

  <resultMap id="CadastroResults" type="Cadastro">
    <result property="id" column="cadastroid"/>
    <result property="tableTypeEnumValue" column="acao"/>
    <result property="nome" column="nome"/>
    <result property="descricao" column="descricao"/>
    <result property="controleid" column="controleid"/>
    <collection property="acessos" column="cadastroid" select="ControleAcessMap.fetchControleAcessByProduto" />
  </resultMap>

  <resultMap id="EmbalagemResult" type="Embalagem">
    <result property="id" column="id"/>
    <result property="nome" column="nome"/>
    <result property="qnt" column="qnt"/>
    <association property="produtos" column="id" javaType="Integer" select="fetchCountEmbalagem"/>
    <association property="unimedid" column="unimedid" javaType="UniMed" select="fetchUniMedByCode" />
    <collection property="acessos" column="id" select="ControleAcessMap.fetchAllControleByEmbalagem" />
  </resultMap>

  <resultMap id="UniMedResult" type="UniMed">
    <result property="id" column="id"/>
    <result property="nome" column="nome"/>
    <result property="sigla" column="sigla"/>
    <collection property="acessos" column="id" select="ControleAcessMap.fetchAllControleByUnimed" />
  </resultMap>



  <select id="fetchUniMedByEmbalagem" parameterType="int" resultMap="EmbalagemResult">
	    SELECT
	    <include refid="allEmbalagemColumns" />
	    FROM embalagem where id = #{id}  ORDER BY id DESC
    </select>

  <select id="fetchCountProduto" parameterType="Integer" resultType="Integer">
    select count(*) as Total from produto t where t.menu = #{id}
  </select>

   <sql id="allEmbalagemColumns">
		id, nome, qnt, unimedid
   </sql>

   <sql id="allUniMedColumns">
		id, sigla, nome
   </sql>

 <select id="fetchCountEmbalagem" parameterType="Integer" resultType="Integer">
   select count(*) as total from produto p ,embalagem e where p.embalagem = e.id and p.embalagem = #{id}
  </select>


  <sql id="allCadastroColumns">
		cadastroid, acao, nome,descricao
  </sql>

  <sql id="allCadastroColumnsWithQualifier">
		p.cadastroid, p.acao, p.nome,p.descricao
  </sql>

<sql id="allProdutoColumns">
		PRODUTOID, CODBARRA, NOME, MARCA, MENU,DESCRICAO SUBMENU, TRIMENU, UNIMED,PRECOID, CONTROLEID, FOTO, SUPERMERCADOID
  </sql>

  <sql id="allProdutoColumnsWithQualifier">
		p.PRODUTOID, p.CODBARRA, p.NOME,p.DESCRICAO, p.MARCA, p.MENU, p.SUBMENU, p.TRIMENU, p.UNIMED,
            p.PRECOID, p.CONTROLEID, p.FOTO, p.SUPERMERCADOID
  </sql>


  <select id="fetchAllProdutosBySupermercado" parameterType="int" resultMap="ProdutoResult2">
	select p.* from produto p,tabpreco t where p.produtoid = t.produtoid and t.supermercadoid = #{id}
	order by p.nome
    </select>

    <select id="fetchMarcaByCode" parameterType="int" resultMap="CadastroResults">
	    SELECT
	    <include refid="allCadastroColumns" />
	    FROM cadastro where acao = 3 and cadastroid = #{id}  ORDER BY nome ASC
    </select>

    <select id="fetchProdutosByMenu" parameterType="int" resultMap="ProdutoResult">
	    SELECT
	    <include refid="allProdutoColumns" />
	    FROM produto where menu = #{id}  ORDER BY nome ASC
    </select>

     <select id="fetchProdutosByMarca" parameterType="int" resultMap="ProdutoResult">
	    SELECT
	    <include refid="allProdutoColumns" />
	    FROM produto where marca = #{id} or
	    				   MENU = #{id} or
	    				   UNIMED = #{id}
	    				 ORDER BY nome ASC
    </select>

     <select id="fetchProdutosBySubMenu" parameterType="int" resultMap="ProdutoResult">
	    SELECT
	    <include refid="allProdutoColumns" />
	    FROM produto where submenu = #{id}  ORDER BY nome ASC
    </select>

    <select id="fetchProdutosByTriMenu" parameterType="int" resultMap="ProdutoResult">
	    SELECT
	    <include refid="allProdutoColumns" />
	    FROM produto where trimenu = #{id}  ORDER BY nome ASC
    </select>

    <select id="fetchProdutosByUnimed" parameterType="int" resultMap="ProdutoResult">
	    SELECT
	    <include refid="allProdutoColumns" />
	    FROM produto where unimed = #{id}  ORDER BY nome ASC
    </select>

    <select id="fetchMenuByCode" parameterType="int" resultMap="CadastroResults">
	    SELECT
	    <include refid="allCadastroColumns" />
	    FROM cadastro where acao in(4,5,6) and cadastroid = #{id}  ORDER BY nome ASC
    </select>

    <select id="fetchMenuByProduto" parameterType="int" resultMap="CadastroResults">
	    SELECT
	    <include refid="allCadastroColumns" />
	    FROM cadastro where acao in(4,5,6)  ORDER BY nome ASC
    </select>

    <select id="fetchSubMenuByCode" parameterType="int" resultMap="CadastroResult">
	    SELECT
	    <include refid="allCadastroColumns" />
	    FROM cadastro where acao = 3 and cadastroid = #{id}  ORDER BY nome ASC
    </select>

    <select id="fetchTriMenuByCode" parameterType="int" resultMap="CadastroResult">
	    SELECT
	    <include refid="allCadastroColumns" />
	    FROM cadastro where acao = 4 and cadastroid = #{id}  ORDER BY nome ASC
    </select>

    <select id="fetchUniMedByCode" parameterType="int" resultMap="UniMedResult">
	    SELECT
	    <include refid="allUniMedColumns" />
	    FROM unimed where id = #{id}  ORDER BY nome DESC
    </select>

  <select id="fetchAllCadastro" parameterType="Cadastro" resultMap="CadastroResult">
    SELECT
    <include refid="allCadastroColumns" />
    FROM cadastro where acao = #{tableTypeEnumValue}} ORDER BY nome ASC
  </select>

   <select id="fetchAllProduto" parameterType="Produto" resultMap="ProdutoResult">
    SELECT
    <include refid="allProdutoColumns" />
    FROM produto  ORDER BY nome ASC
  </select>

  <select id="fetchAllCadastroPagedBatch" parameterType="Cadastro" resultMap="CadastroResult">

		SELECT <include refid="allCadastroColumns" />
   		  FROM cadastro where acao =  #{tableTypeEnumValue} ORDER BY cadastroid ASC
		  OFFSET ( #{_page} * #{_pagesize} )
		  LIMIT #{_pagesize}
  </select>

   <select id="fetchAllProdutoPagedBatch" parameterType="Produto" resultMap="ProdutoResult">

		SELECT <include refid="allProdutoColumns" />
   		  FROM produto  ORDER BY produtoid ASC
		  OFFSET ( #{_page} * #{_pagesize} )
		  LIMIT #{_pagesize}
  </select>

  <select id="fetchCadastroRowCount" parameterType="CadastroInquiryRequest" resultType="Integer">
		SELECT COUNT(*) AS RECORD_COUNT FROM CADASTRO WHERE ACAO =  #{cadastro.tableTypeEnumValue}
  </select>

  <select id="fetchProdutoRowCount" parameterType="ProdutoInquiryRequest" resultType="Integer">
		SELECT COUNT(*) AS RECORD_COUNT FROM PRODUTO
  </select>

  <select id="fetchAllCadastrosRequest" parameterType="CadastroInquiryRequest" resultMap="CadastroResult">
		SELECT <include refid="allCadastroColumns" />
   		  FROM cadastro where acao =  #{cadastro.tableTypeEnumValue} ORDER BY cadastroid ASC
		  OFFSET ( #{startPage} * #{pageSize} )
		  LIMIT #{pageSize}
  </select>

  <select id="fetchAllProdutosRequest" parameterType="ProdutoInquiryRequest" resultMap="ProdutoResult">
		SELECT <include refid="allProdutoColumns" />
   		  FROM PRODUTO ORDER BY produtoid ASC
		  OFFSET ( #{startPage} * #{pageSize} )
		  LIMIT #{pageSize}
  </select>

  <select id="fetchAllProdutos" parameterType="ProdutoInquiryRequest" resultMap="ProdutoResult">
		SELECT <include refid="allProdutoColumns" />
   		  FROM PRODUTO
   		  ORDER BY nome ASC
  </select>

   <select id="fetchAllProdutosSupermercado" parameterType="ProdutoInquiryRequest" resultMap="ProdutoResult">
		SELECT <include refid="allProdutoColumns" />
   		  FROM PRODUTO
   		  <where>
			<if test="produto.marca.id != null">and marca = #{produto.marca.id}</if>
			<if test="produto.menu.id != null">and menu = #{produto.menu.id}</if>
			<if test="produto.codBarra != null">and codBarra = #{produto.codBarra}</if>
			<if test="produto.nome != null">AND nome = #{produto.nome}</if>
			<if test="produto.unimed.id != null">AND unimed = #{produto.unimed.id}</if>
		</where>
   		  ORDER BY nome ASC
  </select>

  <select id="fetchAllCadastros" parameterType="Cadastro" resultMap="CadastroResult">
		SELECT <include refid="allCadastroColumns" />
   		  FROM Cadastro
		<where>
			<if test="tableTypeEnumValue != 1">acao = #{tableTypeEnumValue}</if>
			<if test="descricao != null">and descricao = #{descricao}</if>
			<if test="nome != null">AND nome = #{nome}</if>

		</where>
   		  ORDER BY nome ASC
  </select>

  <select id="fetchAllCadastrosTotal" parameterType="Cadastro" resultMap="CadastroResult">
		SELECT <include refid="allCadastroColumns" />
   		  FROM Cadastro
   		  ORDER BY cadastroid ASC
  </select>

  <select id="fetchCadastroById" parameterType="Cadastro" resultMap="CadastroResult">
    SELECT
   <include refid="allCadastroColumns" />
     FROM cadastro where acao =  #{tableTypeEnumValue} AND cadastroid = #{id}
  </select>

   <select id="fetchProdutoById" parameterType="Produto" resultMap="ProdutoResult">
    SELECT
   <include refid="allProdutoColumns" />
     FROM PRODUTO where produtoid = #{id}
  </select>
  <select id="fetchProdutoByIdInt" parameterType="int" resultMap="ProdutoResult">
    SELECT
   <include refid="allProdutoColumns" />
     FROM PRODUTO where produtoid = #{id}
  </select>


  <select id="insertCadastro" parameterType="Cadastro" resultType="int" statementType="CALLABLE">
        { call ins_cadastro( #{descricao}, #{nome},#{tableTypeEnumValue},#{userId} ) }

  </select>

  <select id="insertProduto" parameterType="HashMap" resultType="int" statementType="CALLABLE">
        { call ins_produto( #{produtoid} , #{codbarra} , #{nome} , #{marca} , #{menu}, #{unimed} , #{foto} ,#{descricao} ,  #{usuarioid} ) }
  </select>


  <select id="updateCadastro" parameterType="Cadastro" resultType="int" statementType="CALLABLE">
     { call upd_cadastro(  #{id},#{descricao}, #{nome},#{tableTypeEnumValue},#{userId} ) }
  </select>

  <select id="updateProduto" parameterType="HashMap" resultType="int" statementType="CALLABLE">
	{ call upd_produto( #{produtoid} , #{codbarra} , #{nome} , #{marca} , #{menu}, #{unimed} , #{foto} ,#{descricao} ,  #{usuarioid} ) }
  </select>

  <select id="deleteCadastroById" parameterType="Cadastro" resultType="int" statementType="CALLABLE">
        { call del_cadastro( #{id} , #{tableTypeEnumValue}, #{userId} ) }

  </select>

  <delete id="deleteAllCadastros">
	DELETE FROM cADASTRO
  </delete>

   <select id="deleteProdutoById" parameterType="Produto" resultType="int" statementType="CALLABLE">
   { call del_produto( #{id} , #{userId} ) }
  </select>

  <delete id="deleteAllProdutos">
	DELETE FROM PRODUTO
  </delete>


    <select id="insertEmbalagem" parameterType="Embalagem" resultType="int" statementType="CALLABLE">
        { call ins_embalagem( #{nome} , #{qnt} , #{unimedid.id},  #{userId} ) }

  </select>

  <select id="insertUniMed" parameterType="UniMed" resultType="int" statementType="CALLABLE">
        { call ins_unimed( #{sigla},#{nome},  #{userId} ) }
  </select>


  <select id="updateEmbalagem" parameterType="Embalagem" resultType="int" statementType="CALLABLE">
     { call upd_embalagem(  #{id}, #{nome} , #{qnt} , #{unimedid.id},  #{userId} ) }
  </select>

  <select id="updateUniMed" parameterType="UniMed" resultType="int" statementType="CALLABLE">
	{ call upd_unimed( #{id}, #{sigla}, #{nome},  #{userId} ) }
  </select>

  <select id="deleteEmbalagemById" parameterType="Embalagem" resultType="int" statementType="CALLABLE">
        { call del_embalagem( #{id} , #{userId} ) }
  </select>

   <select id="deleteUniMedById" parameterType="UniMed" resultType="int" statementType="CALLABLE">
        { call del_unimed( #{id} ,  #{userId} ) }
  </select>

  <select id="fetchAllEmbalagems" parameterType="Embalagem" resultMap="EmbalagemResult">
		SELECT <include refid="allEmbalagemColumns" />
   		  FROM Embalagem
		<where>
			<if test="id !=null">id is not null</if>
			<if test="id !=null">and id = #{id}</if>
			<if test="nome != null">and nome = #{nome}</if>
			<if test="qnt != null">and qnt = #{qnt}</if>

		</where>
   		  ORDER BY qnt ASC
  </select>

  <select id="fetchAllUniMeds" parameterType="UniMed" resultMap="UniMedResult">
		SELECT <include refid="allUniMedColumns" />
   		  FROM unimed
		<where>
			<if test="id !=null">id is not null</if>
			<if test="id !=null">and id = #{id}</if>
			<if test="nome != null">nome = #{nome}</if>
			<if test="sigla != null">and sigla = #{sigla}</if>

		</where>
   		  ORDER BY id DESC
  </select>

</mapper>
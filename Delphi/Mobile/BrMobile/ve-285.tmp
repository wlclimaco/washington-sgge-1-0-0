using System;
using System.Collections.Generic;
using System.Text;
using System.Data.SqlServerCe;

namespace LogosMobileSaidaBayer
{
    public class BayerSaida
    {
        public bool Clear(ref SqlCeConnection conexao)
        {
            bool vlresult = false;
            SqlCeCommand cmd;

            string sql = "Delete From Saida";

            try
            {
                cmd = new SqlCeCommand(sql, conexao);
                cmd.ExecuteNonQuery();
                vlresult = true;
            }
            catch (SqlCeException sqlexception)
            {
                Controller.ShowMessage("Erro durante comando CLEAR: " + sqlexception.Message);
            }
            return vlresult;
        }

        public bool Insert(ref SqlCeConnection conexao, string[] Registro, string nrmapa, int idx)
        {
            bool vlresult = false;
            SqlCeCommand cmd;

            string sql = "Insert Into Saida " +
                         "( NRGTIN,  NRLOTE,  DTVALID,  DSPRODUT,  QTPRODUT,  NRCONTAG,  NRCONATU,  STITEM, DTPRODUC,  NRSSCC, DTCOLETA) " +
                         "Values " +
                         "(@NRGTIN, @NRLOTE, @DTVALID, @DSPRODUT, @QTPRODUT, @NRCONTAG, @NRCONATU, @STITEM,     NULL, @NRSSCC,     NULL) ";
            try
            {
                string nrsscc = Registro[0] + Registro[3] + idx.ToString();

                cmd = new SqlCeCommand(sql, conexao);
                cmd.Parameters.AddWithValue("@NRGTIN", Registro[0]);
                cmd.Parameters.AddWithValue("@NRLOTE", Registro[3]);
                cmd.Parameters.AddWithValue("@DTVALID", Registro[4]);
                cmd.Parameters.AddWithValue("@DSPRODUT", Registro[1]);
                cmd.Parameters.AddWithValue("@QTPRODUT", Registro[2]);
                cmd.Parameters.AddWithValue("@NRSSCC", nrsscc);
                cmd.Parameters.AddWithValue("@NRCONTAG", "0");
                cmd.Parameters.AddWithValue("@NRCONATU", "1");
                cmd.Parameters.AddWithValue("@STITEM", "R");
                cmd.ExecuteNonQuery();
                vlresult = true;
            }
            catch (SqlCeException sqlexception)
            {
                Controller.ShowMessage("Erro durante comando Insert: " + sqlexception.Message);
            }
            return vlresult;
        }

        public string GeraListagem(ref SqlCeConnection conexao, string nrmapa)
        {
            string vlresult = string.Empty;
            SqlCeCommand cmd;

            string nrgtin = string.Empty;
            string nrlote = string.Empty;
            string dtvalid = string.Empty;
            string nrsscc = string.Empty;
            string dtproduc = string.Empty;
            string dtcoleta = string.Empty;
            string stitem = string.Empty;
            decimal qtprodut = 0;

            string sql = "Select NRGTIN,NRLOTE,DTVALID,NRSSCC,DTPRODUC,DTCOLETA,QTPRODUT,STITEM " +
                         "From Saida " +
                         "Where STITEM in ('C', 'D') ";
            try
            {
                cmd = new SqlCeCommand(sql, conexao);
                cmd.CommandType = System.Data.CommandType.Text;
                SqlCeResultSet rs = cmd.ExecuteResultSet(ResultSetOptions.Scrollable);

                if (rs.HasRows)
                {
                    vlresult = "NRMAPA;NRGTIN;NRLOTE;DTVALID;NRSSCC;DTPRODUC;DTCOLETA;QTPRODUT;STITEM\r\n";

                    rs.ReadFirst();
                    nrgtin = rs.GetString(0);
                    nrlote = rs.GetString(1);
                    dtvalid = rs.GetString(2);
                    nrsscc = rs.GetString(3);
                    dtproduc = rs.GetString(4);
                    dtcoleta = rs.GetString(5);
                    qtprodut = rs.GetDecimal(6);
                    stitem = rs.GetString(7);

                    vlresult += nrmapa + ";" + nrgtin + ";" + nrlote + ";" + dtvalid + ";" + nrsscc + ";" +
                                dtproduc + ";" + dtcoleta + ";" + qtprodut.ToString() + ";" + stitem + "\r\n";

                    while (rs.Read())
                    {
                        nrgtin = rs.GetString(0);
                        nrlote = rs.GetString(1);
                        dtvalid = rs.GetString(2);
                        nrsscc = rs.GetString(3);
                        dtproduc = rs.GetString(4);
                        dtcoleta = rs.GetString(5);
                        qtprodut = rs.GetDecimal(6);
                        stitem = rs.GetString(7);

                        vlresult += nrmapa + ";" + nrgtin + ";" + nrlote + ";" + dtvalid + ";" + nrsscc + ";" +
                                    dtproduc + ";" + dtcoleta + ";" + qtprodut.ToString() + ";" + stitem + "\r\n";
                    }
                    return vlresult;
                }
            }
            catch (SqlCeException sqlexception)
            {
                Controller.ShowMessage("Erro durante geração da lista: " + sqlexception.Message);
            }
            return vlresult;
        }

        public bool FindItemExt(ref SqlCeConnection conexao, string cdgtin, string nrlote, string dtproduc,
                                     string dtvalid, string nrsscc)
        {
            bool vlresult = false;
            SqlCeCommand cmd;

            string sql = "Select * From Saida " +
                         "Where NRGTIN   = @NRGTIN   and " +
                         "      NRLOTE   = @NRLOTE   and " +
                         "      DTPRODUC = @DTPRODUC and " +
                         "      DTVALID  = @DTVALID  and " +
                         "      NRSSCC   = @NRSSCC   and " +
                         "      STITEM  in ('C', 'E') ";
            try
            {
                cmd = new SqlCeCommand(sql, conexao);
                cmd.Parameters.AddWithValue("@NRGTIN", cdgtin);
                cmd.Parameters.AddWithValue("@NRLOTE", nrlote);
                cmd.Parameters.AddWithValue("@DTPRODUC", dtproduc);
                cmd.Parameters.AddWithValue("@DTVALID", dtvalid);
                cmd.Parameters.AddWithValue("@NRSSCC", nrsscc);
                cmd.CommandType = System.Data.CommandType.Text;
                SqlCeResultSet rs = cmd.ExecuteResultSet(ResultSetOptions.Scrollable);

                if (rs.HasRows)
                {
                    vlresult = true;
                }
                else
                {
                    vlresult = false;
                }
            }
            catch (SqlCeException sqlexception)
            {
                Controller.ShowMessage("Erro durante comando busca extendida: " + sqlexception.Message);
            }
            return vlresult;
        }

        public int FindItemContag(ref SqlCeConnection conexao, string cdgtin, string nrlote, string dtvalid)
        {
            int vlresult = 0;
            SqlCeCommand cmd;

            string sql = "Select NRCONATU From Saida " +
                         "Where NRGTIN  = @NRGTIN  and " +
                         "      NRLOTE  = @NRLOTE  and " +
                         "      DTVALID = @DTVALID and " +
                         "      STITEM  in ('R', 'X') ";

            try
            {
                cmd = new SqlCeCommand(sql, conexao);
                cmd.Parameters.AddWithValue("@NRGTIN", cdgtin);
                cmd.Parameters.AddWithValue("@NRLOTE", nrlote);
                cmd.Parameters.AddWithValue("@DTVALID", dtvalid);

                string vlCount = "";
                vlCount = cmd.ExecuteScalar().ToString();

                if (vlCount.Trim() == string.Empty)
                {
                    vlresult = 1;
                }
                else
                {
                    vlresult = int.Parse(vlCount);
                }

            }
            catch (SqlCeException sqlexception)
            {
                Controller.ShowMessage("Erro durante busca de contagem: " + sqlexception.Message);
            }
            return vlresult;
        }

        public bool FindItem(ref SqlCeConnection conexao, string cdgtin, string nrlote, string dtvalid, string sqlcompl)
        {
            bool vlresult = false;
            SqlCeCommand cmd;

            string sql = "Select * From Saida " +
                         "Where NRGTIN  = @NRGTIN and " +
                         "      NRLOTE  = @NRLOTE and " +
                         "      DTVALID = @DTVALID " +
                         sqlcompl;
            try
            {
                cmd = new SqlCeCommand(sql, conexao);
                cmd.Parameters.AddWithValue("@NRGTIN", cdgtin);
                cmd.Parameters.AddWithValue("@NRLOTE", nrlote);
                cmd.Parameters.AddWithValue("@DTVALID", dtvalid);
                cmd.CommandType = System.Data.CommandType.Text;
                SqlCeResultSet rs = cmd.ExecuteResultSet(ResultSetOptions.Scrollable);

                if (rs.HasRows)
                {
                    vlresult = true;
                }
                else
                {
                    vlresult = false;
                }
            }
            catch (SqlCeException sqlexception)
            {
                Controller.ShowMessage("Erro durante busca de Item: " + sqlexception.Message);
            }
            return vlresult;
        }

        public bool FinalizarContagem(ref SqlCeConnection conexao)
        {
            bool dsresult = true;
            try
            {
                SqlCeCommand cmd;

                string sql = "Select nrgtin, nrlote, dsprodut, dtvalid, qtprodut from Saida where stitem = 'R'";

                cmd = new SqlCeCommand(sql, conexao);
                cmd.CommandType = System.Data.CommandType.Text;
                SqlCeResultSet RsReferencia = cmd.ExecuteResultSet(ResultSetOptions.Scrollable);

                if (RsReferencia.HasRows)
                {
                    string nrgtin = string.Empty;
                    string nrlote = string.Empty;
                    string dsprodut = string.Empty;
                    string dtvalid = string.Empty;
                    decimal qtprodut = 0;

                    //Consolidando todos os itens não esperados
                    cmd.CommandText = "Update Saida set STITEM = 'C' Where STITEM  = 'X' ";
                    cmd.ExecuteNonQuery();

                    while (RsReferencia.Read())
                    {
                        nrgtin = RsReferencia.GetString(0);
                        nrlote = RsReferencia.GetString(1);
                        dsprodut = RsReferencia.GetString(2);
                        dtvalid = RsReferencia.GetString(3);
                        qtprodut = RsReferencia.GetDecimal(4);

                        cmd.CommandText = "Select Sum(QTPRODUT) " +
                                          "from Saida " +
                                          "where STITEM  = @STITEM and " +
                                          "      NRGTIN  = @NRGTIN  and " +
                                          "      NRLOTE  = @NRLOTE  and " +
                                          "      DTVALID = @DTVALID ";
                        cmd.Parameters.Clear();
                        cmd.Parameters.AddWithValue("@NRGTIN", nrgtin);
                        cmd.Parameters.AddWithValue("@NRLOTE", nrlote);
                        cmd.Parameters.AddWithValue("@DTVALID", dtvalid);
                        cmd.Parameters.AddWithValue("@STITEM", "E");

                        string qtcountaux = cmd.ExecuteScalar().ToString();
                        decimal qtcount = Decimal.Parse(qtcountaux);

                        if (qtprodut != qtcount)
                        {
                            if (!Controller.MessageDlg("Produto " + dsprodut + " divergente!!! \n" +
                                "Deseja continuar?"))
                            {
                                //Atualizando itens contados - Histórico
                                cmd.CommandText = "Update Saida set STITEM = @STITEMNEW" +
                                                  " Where STITEM  = @STITEM and " +
                                                  "       NRGTIN  = @NRGTIN  and " +
                                                  "       NRLOTE  = @NRLOTE  and " +
                                                  "       DTVALID = @DTVALID ";
                                cmd.Parameters.Clear();
                                cmd.Parameters.AddWithValue("@NRGTIN", nrgtin);
                                cmd.Parameters.AddWithValue("@NRLOTE", nrlote);
                                cmd.Parameters.AddWithValue("@DTVALID", dtvalid);
                                cmd.Parameters.AddWithValue("@STITEM", "E");
                                cmd.Parameters.AddWithValue("@STITEMNEW", "H");
                                cmd.ExecuteNonQuery();

                                //Atualizando referencia
                                cmd.CommandText = "Update Saida set NRCONATU = NRCONATU + 1 " +
                                                  " Where STITEM  = @STITEM and " +
                                                  "       NRGTIN  = @NRGTIN  and " +
                                                  "       NRLOTE  = @NRLOTE  and " +
                                                  "       DTVALID = @DTVALID ";
                                cmd.Parameters.Clear();
                                cmd.Parameters.AddWithValue("@NRGTIN", nrgtin);
                                cmd.Parameters.AddWithValue("@NRLOTE", nrlote);
                                cmd.Parameters.AddWithValue("@DTVALID", dtvalid);
                                cmd.Parameters.AddWithValue("@STITEM", "R");
                                cmd.ExecuteNonQuery();

                                dsresult = false;
                                RsReferencia.ReadLast();
                            }
                            else
                            {
                                //Atualizando itens contados
                                cmd.CommandText = " Update Saida set STITEM = @STITEMNEW" +
                                                  " Where STITEM  = @STITEM and " +
                                                  "       NRGTIN  = @NRGTIN  and " +
                                                  "       NRLOTE  = @NRLOTE  and " +
                                                  "       DTVALID = @DTVALID ";
                                cmd.Parameters.Clear();
                                cmd.Parameters.AddWithValue("@NRGTIN", nrgtin);
                                cmd.Parameters.AddWithValue("@NRLOTE", nrlote);
                                cmd.Parameters.AddWithValue("@DTVALID", dtvalid);
                                cmd.Parameters.AddWithValue("@STITEM", "E");
                                cmd.Parameters.AddWithValue("@STITEMNEW", "D");
                                cmd.ExecuteNonQuery();

                                //Atualizando referencia
                                cmd.CommandText = "Update Saida set STITEM = @STITEMNEW" +
                                                  " Where STITEM  = @STITEM and " +
                                                  "       NRGTIN  = @NRGTIN  and " +
                                                  "       NRLOTE  = @NRLOTE  and " +
                                                  "       DTVALID = @DTVALID ";
                                cmd.Parameters.Clear();
                                cmd.Parameters.AddWithValue("@NRGTIN", nrgtin);
                                cmd.Parameters.AddWithValue("@NRLOTE", nrlote);
                                cmd.Parameters.AddWithValue("@DTVALID", dtvalid);
                                cmd.Parameters.AddWithValue("@STITEM", "R");
                                cmd.Parameters.AddWithValue("@STITEMNEW", "V");
                                cmd.ExecuteNonQuery();
                            }
                        }
                        else
                        {
                            //Atualizando itens contados
                            cmd.CommandText = " Update Saida set STITEM = @STITEMNEW" +
                                              " Where STITEM  = @STITEM and " +
                                              "       NRGTIN  = @NRGTIN  and " +
                                              "       NRLOTE  = @NRLOTE  and " +
                                              "       DTVALID = @DTVALID ";
                            cmd.Parameters.Clear();
                            cmd.Parameters.AddWithValue("@NRGTIN", nrgtin);
                            cmd.Parameters.AddWithValue("@NRLOTE", nrlote);
                            cmd.Parameters.AddWithValue("@DTVALID", dtvalid);
                            cmd.Parameters.AddWithValue("@STITEM", "E");
                            cmd.Parameters.AddWithValue("@STITEMNEW", "C");
                            cmd.ExecuteNonQuery();

                            //Atualizando referencia
                            cmd.CommandText = "Update Saida set STITEM = @STITEMNEW" +
                                              " Where STITEM  = @STITEM and " +
                                              "       NRGTIN  = @NRGTIN  and " +
                                              "       NRLOTE  = @NRLOTE  and " +
                                              "       DTVALID = @DTVALID ";
                            cmd.Parameters.Clear();
                            cmd.Parameters.AddWithValue("@NRGTIN", nrgtin);
                            cmd.Parameters.AddWithValue("@NRLOTE", nrlote);
                            cmd.Parameters.AddWithValue("@DTVALID", dtvalid);
                            cmd.Parameters.AddWithValue("@STITEM", "R");
                            cmd.Parameters.AddWithValue("@STITEMNEW", "F");
                            cmd.ExecuteNonQuery();
                        }
                    }
                }
            }
            catch (SqlCeException sqlexception)
            {
                Controller.ShowMessage("Erro durante finalizacao: " + sqlexception.Message);
                dsresult = false;
            }
            return dsresult;
        }

        public void AlimentaSaida(ref SqlCeConnection conexao, string lista, string nrmapa)
        {
            string DsList = lista;
            const string dscabec = "NRGTIN;DSPRODUT;QTPRODUT;NRLOTE;DTVALID";
            char[] DsSepLin = { '#' };
            char[] DsSepVal = { ';' };
            string[] lines;
            string[] values;

            DsList = DsList.Replace("\r\n", "#");
            DsList = DsList.Replace("##", "#");

            lines = DsList.Split(DsSepLin);

            if (dscabec.ToUpper() != lines[0].ToUpper())
            {
                throw new Exception(String.Format("Lista de Saida não conforme: {0}", lines[0]));
            }

            Clear(ref conexao);

            for (int idx = 1; idx < lines.Length; idx++)
            {
                if (lines[idx].Trim() != string.Empty)
                {
                    values = lines[idx].Split(DsSepVal);
                    Insert(ref conexao, values, nrmapa, idx);
                }
            }
        }

        public bool InsertContagem(ref SqlCeConnection conexao, string cdgtin, string nrlote, string dtproduc,
                                   string dtvalid, string nrsscc, bool snconsol, float qtprodut)
        {
            bool vlresult = false;
            SqlCeCommand cmd;

            string sql = "Insert Into Saida " +
                         "( NRGTIN,  NRLOTE,  DTVALID, DSPRODUT,  QTPRODUT,  DTPRODUC,  NRSSCC,  DTCOLETA,  NRCONTAG,  STITEM) " +
                         "Values " +
                         "(@NRGTIN, @NRLOTE, @DTVALID,     NULL, @QTPRODUT, @DTPRODUC, @NRSSCC, @DTCOLETA, @NRCONTAG, @STITEM) ";

            try
            {
                string dtcoleta = DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss");
                int nrcontag = 1;

                cmd = new SqlCeCommand(sql, conexao);
                cmd.Parameters.AddWithValue("@NRGTIN", cdgtin);
                cmd.Parameters.AddWithValue("@NRLOTE", nrlote);
                cmd.Parameters.AddWithValue("@DTPRODUC", dtproduc);
                cmd.Parameters.AddWithValue("@DTVALID", dtvalid);
                cmd.Parameters.AddWithValue("@NRSSCC", nrsscc);
                cmd.Parameters.AddWithValue("@QTPRODUT", qtprodut);
                cmd.Parameters.AddWithValue("@DTCOLETA", dtcoleta);

                if (snconsol)
                {
                    cmd.Parameters.AddWithValue("@STITEM", "X");
                }
                else
                {
                    nrcontag = FindItemContag(ref conexao, cdgtin, nrlote, dtvalid);
                    cmd.Parameters.AddWithValue("@STITEM", "E");
                }

                cmd.Parameters.AddWithValue("@NRCONTAG", nrcontag);
                cmd.ExecuteNonQuery();
                vlresult = true;
            }
            catch (SqlCeException sqlexception)
            {
                Controller.ShowMessage("Erro durante Insercao de contagem: " + sqlexception.Message);
            }

            return vlresult;

        }
    }
}